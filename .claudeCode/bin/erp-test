#!/usr/bin/env node

/**
 * /erp:test - ERP Test Execution Command
 *
 * Comprehensive test suite for Korean ERP system
 * - Unit tests
 * - API integration tests
 * - Security tests
 * - Test coverage reporting
 */

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

const colors = {
  reset: '\x1b[0m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  red: '\x1b[31m',
  blue: '\x1b[34m',
  cyan: '\x1b[36m'
};

function log(message, color = 'reset') {
  console.log(`${colors[color]}${message}${colors.reset}`);
}

function exec(command, description, continueOnError = false) {
  log(`\nğŸ§ª ${description}...`, 'cyan');
  try {
    execSync(command, { stdio: 'inherit' });
    log(`âœ… ${description} í†µê³¼`, 'green');
    return { success: true };
  } catch (error) {
    log(`âŒ ${description} ì‹¤íŒ¨`, 'red');
    if (!continueOnError) {
      return { success: false, error };
    }
    return { success: false, error, continued: true };
  }
}

async function runTestSuite() {
  log('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—', 'blue');
  log('â•‘     íƒœì°½ ERP í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...      â•‘', 'blue');
  log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n', 'blue');

  const args = process.argv.slice(2);
  const coverage = args.includes('--coverage');
  const watch = args.includes('--watch');
  const api = args.includes('--api');
  const lib = args.includes('--lib');
  const security = args.includes('--security');
  const all = args.includes('--all') || args.length === 0;

  const results = [];

  // 1. Unit tests (lib)
  if (lib || all) {
    const result = exec(
      watch ? 'npm run test:watch' : 'npm run test:lib',
      'ìœ í‹¸ë¦¬í‹° ë¼ì´ë¸ŒëŸ¬ë¦¬ í…ŒìŠ¤íŠ¸',
      true
    );
    results.push({ name: 'Unit Tests', ...result });
  }

  // 2. API tests
  if (api || all) {
    const result = exec(
      'npm run test:api',
      'API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸',
      true
    );
    results.push({ name: 'API Tests', ...result });
  }

  // 3. Security tests
  if (security || all) {
    const result = exec(
      'npm run test:security',
      'ë³´ì•ˆ ì·¨ì•½ì  í…ŒìŠ¤íŠ¸',
      true
    );
    results.push({ name: 'Security Tests', ...result });
  }

  // 4. Coverage report
  if (coverage && !watch) {
    const result = exec(
      'npm run test:coverage',
      'í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ìƒì„±',
      true
    );
    results.push({ name: 'Coverage Report', ...result });

    // Read coverage summary if available
    const coveragePath = path.join(process.cwd(), 'coverage', 'coverage-summary.json');
    if (fs.existsSync(coveragePath)) {
      const coverageData = JSON.parse(fs.readFileSync(coveragePath, 'utf8'));
      const total = coverageData.total;

      log('\nğŸ“Š í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ìš”ì•½:', 'cyan');
      log(`   - ë¼ì¸ ì»¤ë²„ë¦¬ì§€: ${total.lines.pct.toFixed(2)}%`, 'cyan');
      log(`   - ë¸Œëœì¹˜ ì»¤ë²„ë¦¬ì§€: ${total.branches.pct.toFixed(2)}%`, 'cyan');
      log(`   - í•¨ìˆ˜ ì»¤ë²„ë¦¬ì§€: ${total.functions.pct.toFixed(2)}%`, 'cyan');
      log(`   - êµ¬ë¬¸ ì»¤ë²„ë¦¬ì§€: ${total.statements.pct.toFixed(2)}%`, 'cyan');

      if (total.lines.pct < 80) {
        log('\nâš ï¸  ê²½ê³ : ë¼ì¸ ì»¤ë²„ë¦¬ì§€ê°€ 80% ë¯¸ë§Œì…ë‹ˆë‹¤', 'yellow');
      }
    }
  }

  // 5. Summary
  log('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—', 'blue');
  log('â•‘          í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½            â•‘', 'blue');
  log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n', 'blue');

  const passed = results.filter(r => r.success).length;
  const failed = results.filter(r => !r.success).length;

  results.forEach(result => {
    const status = result.success ? 'âœ… í†µê³¼' : 'âŒ ì‹¤íŒ¨';
    const color = result.success ? 'green' : 'red';
    log(`${status} - ${result.name}`, color);
  });

  log(`\nì´ ${results.length}ê°œ í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸`, 'cyan');
  log(`í†µê³¼: ${passed}ê°œ`, 'green');
  if (failed > 0) {
    log(`ì‹¤íŒ¨: ${failed}ê°œ`, 'red');
  }

  if (failed > 0) {
    log('\nâŒ ì¼ë¶€ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'red');
    process.exit(1);
  } else {
    log('\nâœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí–ˆìŠµë‹ˆë‹¤!', 'green');

    if (coverage) {
      log('\nğŸ“Š ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸: coverage/lcov-report/index.html', 'cyan');
    }
  }
}

function showHelp() {
  log('\níƒœì°½ ERP í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë„êµ¬', 'blue');
  log('\nì‚¬ìš©ë²•:', 'cyan');
  log('  /erp:test [ì˜µì…˜]\n', 'cyan');
  log('ì˜µì…˜:', 'cyan');
  log('  --all        ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ê¸°ë³¸ê°’)', 'cyan');
  log('  --lib        ìœ í‹¸ë¦¬í‹° ë¼ì´ë¸ŒëŸ¬ë¦¬ í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰', 'cyan');
  log('  --api        API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰', 'cyan');
  log('  --security   ë³´ì•ˆ í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰', 'cyan');
  log('  --coverage   ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ìƒì„±', 'cyan');
  log('  --watch      Watch ëª¨ë“œë¡œ ì‹¤í–‰', 'cyan');
  log('  --help       ë„ì›€ë§ í‘œì‹œ\n', 'cyan');
  log('ì˜ˆì‹œ:', 'yellow');
  log('  /erp:test --api --coverage', 'yellow');
  log('  /erp:test --lib --watch', 'yellow');
  log('  /erp:test --all --coverage\n', 'yellow');
}

async function main() {
  const args = process.argv.slice(2);

  if (args.includes('--help') || args.includes('-h')) {
    showHelp();
    return;
  }

  await runTestSuite();
}

main().catch(error => {
  log(`\nâŒ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'red');
  process.exit(1);
});
