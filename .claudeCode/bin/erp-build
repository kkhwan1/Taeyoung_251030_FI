#!/usr/bin/env node

/**
 * /erp:build - ERP Build & Deploy Command
 *
 * Automated build pipeline for Korean ERP system
 * - Type checking
 * - Linting
 * - Production build with Turbopack
 * - Database migration verification
 * - Bundle analysis (optional)
 */

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

const colors = {
  reset: '\x1b[0m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  red: '\x1b[31m',
  blue: '\x1b[34m',
  cyan: '\x1b[36m'
};

function log(message, color = 'reset') {
  console.log(`${colors[color]}${message}${colors.reset}`);
}

function exec(command, description) {
  log(`\nğŸ”¨ ${description}...`, 'cyan');
  try {
    execSync(command, { stdio: 'inherit' });
    log(`âœ… ${description} ì™„ë£Œ`, 'green');
    return true;
  } catch (error) {
    log(`âŒ ${description} ì‹¤íŒ¨`, 'red');
    return false;
  }
}

async function main() {
  log('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—', 'blue');
  log('â•‘   íƒœì°½ ERP ì‹œìŠ¤í…œ ë¹Œë“œ íŒŒì´í”„ë¼ì¸   â•‘', 'blue');
  log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n', 'blue');

  const args = process.argv.slice(2);
  const skipTests = args.includes('--skip-tests');
  const analyze = args.includes('--analyze');
  const deploy = args.includes('--deploy');

  // 1. Type checking
  if (!exec('npm run type-check', 'TypeScript íƒ€ì… ì²´í¬')) {
    process.exit(1);
  }

  // 2. Linting
  if (!exec('npm run lint', 'ESLint ì½”ë“œ ê²€ì‚¬')) {
    log('âš ï¸  ë¦°íŠ¸ ê²½ê³ ê°€ ìˆì§€ë§Œ ë¹Œë“œë¥¼ ê³„ì†í•©ë‹ˆë‹¤', 'yellow');
  }

  // 3. Test suite (optional)
  if (!skipTests) {
    if (!exec('npm run test:all', 'ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰')) {
      log('âš ï¸  ì¼ë¶€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨, ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (Ctrl+Cë¡œ ì·¨ì†Œ)', 'yellow');
      await new Promise(resolve => setTimeout(resolve, 3000));
    }
  }

  // 4. Database migration status
  if (!exec('npm run migrate:status', 'DB ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ í™•ì¸')) {
    log('âš ï¸  ë§ˆì´ê·¸ë ˆì´ì…˜ í™•ì¸ ì‹¤íŒ¨', 'yellow');
  }

  // 5. Production build
  const buildCommand = analyze
    ? 'npm run build:analyze'
    : 'npm run build';

  if (!exec(buildCommand, 'í”„ë¡œë•ì…˜ ë¹Œë“œ')) {
    process.exit(1);
  }

  // 6. Build info
  const buildInfo = {
    timestamp: new Date().toISOString(),
    version: require(path.join(process.cwd(), 'package.json')).version,
    node: process.version,
    analyze: analyze
  };

  fs.writeFileSync(
    path.join(process.cwd(), '.next', 'build-info.json'),
    JSON.stringify(buildInfo, null, 2)
  );

  log('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—', 'green');
  log('â•‘        ë¹Œë“œ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë¨        â•‘', 'green');
  log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n', 'green');

  log(`ğŸ“¦ ë¹Œë“œ ë²„ì „: ${buildInfo.version}`, 'cyan');
  log(`â° ë¹Œë“œ ì‹œê°„: ${buildInfo.timestamp}`, 'cyan');

  if (analyze) {
    log('\nğŸ“Š ë²ˆë“¤ ë¶„ì„ ê²°ê³¼ëŠ” ë¸Œë¼ìš°ì €ì—ì„œ í™•ì¸í•˜ì„¸ìš”', 'yellow');
  }

  if (deploy) {
    log('\nğŸš€ ë°°í¬ í”„ë¡œì„¸ìŠ¤ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...', 'blue');
    exec('npm run start', 'í”„ë¡œë•ì…˜ ì„œë²„ ì‹œì‘');
  }
}

main().catch(error => {
  log(`\nâŒ ë¹Œë“œ ì‹¤íŒ¨: ${error.message}`, 'red');
  process.exit(1);
});
