#!/usr/bin/env node

/**
 * /erp:migrate - ERP Database Migration Helper
 *
 * Interactive database migration management
 * - Migration status check
 * - Apply pending migrations
 * - Rollback migrations
 * - Database schema validation
 */

const { execSync } = require('child_process');
const readline = require('readline');

const colors = {
  reset: '\x1b[0m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  red: '\x1b[31m',
  blue: '\x1b[34m',
  cyan: '\x1b[36m'
};

function log(message, color = 'reset') {
  console.log(`${colors[color]}${message}${colors.reset}`);
}

function exec(command, silent = false) {
  try {
    return execSync(command, { stdio: silent ? 'pipe' : 'inherit', encoding: 'utf8' });
  } catch (error) {
    return null;
  }
}

function prompt(question) {
  const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout
  });

  return new Promise(resolve => {
    rl.question(question, answer => {
      rl.close();
      resolve(answer.trim().toLowerCase());
    });
  });
}

async function checkMigrationStatus() {
  log('\nğŸ“Š ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ í™•ì¸ ì¤‘...', 'cyan');
  const status = exec('npm run migrate:status', true);

  if (status) {
    console.log(status);
    return true;
  }

  log('âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨', 'red');
  return false;
}

async function applyMigrations() {
  log('\nâ¬†ï¸  ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš© ì¤‘...', 'cyan');

  const confirm = await prompt('ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (yes/no): ');

  if (confirm === 'yes' || confirm === 'y') {
    const result = exec('npm run migrate:up');
    if (result !== null) {
      log('âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš© ì™„ë£Œ', 'green');

      // Verify schema after migration
      log('\nğŸ” ìŠ¤í‚¤ë§ˆ ê²€ì¦ ì¤‘...', 'cyan');
      exec('npm run db:check-schema');
    } else {
      log('âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš© ì‹¤íŒ¨', 'red');
    }
  } else {
    log('ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤', 'yellow');
  }
}

async function rollbackMigration() {
  log('\nâ¬‡ï¸  ë§ˆì´ê·¸ë ˆì´ì…˜ ë¡¤ë°± ì¤€ë¹„...', 'yellow');

  const confirm = await prompt('âš ï¸  ë§ˆì§€ë§‰ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ë¡¤ë°±í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (yes/no): ');

  if (confirm === 'yes' || confirm === 'y') {
    const result = exec('npm run migrate:down');
    if (result !== null) {
      log('âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ë¡¤ë°± ì™„ë£Œ', 'green');
    } else {
      log('âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ ë¡¤ë°± ì‹¤íŒ¨', 'red');
    }
  } else {
    log('ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤', 'yellow');
  }
}

async function resetDatabase() {
  log('\nğŸ”„ ë°ì´í„°ë² ì´ìŠ¤ ë¦¬ì…‹ ì¤€ë¹„...', 'yellow');
  log('âš ï¸  ê²½ê³ : ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ê³  ì²˜ìŒë¶€í„° ë§ˆì´ê·¸ë ˆì´ì…˜ì´ ì¬ì‹¤í–‰ë©ë‹ˆë‹¤!', 'red');

  const confirm = await prompt('ì •ë§ë¡œ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë¦¬ì…‹í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (yes/no): ');

  if (confirm === 'yes' || confirm === 'y') {
    const doubleConfirm = await prompt('í•œ ë²ˆ ë” í™•ì¸í•©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (yes/no): ');

    if (doubleConfirm === 'yes' || doubleConfirm === 'y') {
      const result = exec('npm run migrate:reset');
      if (result !== null) {
        log('âœ… ë°ì´í„°ë² ì´ìŠ¤ ë¦¬ì…‹ ì™„ë£Œ', 'green');

        // Re-seed data
        const seedConfirm = await prompt('ê°œë°œ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (yes/no): ');
        if (seedConfirm === 'yes' || seedConfirm === 'y') {
          exec('npm run seed:dev');
        }
      } else {
        log('âŒ ë°ì´í„°ë² ì´ìŠ¤ ë¦¬ì…‹ ì‹¤íŒ¨', 'red');
      }
    } else {
      log('ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤', 'yellow');
    }
  } else {
    log('ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤', 'yellow');
  }
}

async function checkSchema() {
  log('\nğŸ” ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ê²€ì¦ ì¤‘...', 'cyan');
  exec('npm run db:check-schema');

  log('\nğŸ“Š í…Œì´ë¸” ë°ì´í„° í™•ì¸ ì¤‘...', 'cyan');
  exec('npm run db:check-data');
}

async function showMenu() {
  log('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—', 'blue');
  log('â•‘    íƒœì°½ ERP DB ë§ˆì´ê·¸ë ˆì´ì…˜ ë„êµ¬    â•‘', 'blue');
  log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n', 'blue');

  log('1. ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ í™•ì¸', 'cyan');
  log('2. ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš© (migrate:up)', 'cyan');
  log('3. ë§ˆì´ê·¸ë ˆì´ì…˜ ë¡¤ë°± (migrate:down)', 'cyan');
  log('4. ë°ì´í„°ë² ì´ìŠ¤ ë¦¬ì…‹ (âš ï¸  ìœ„í—˜)', 'yellow');
  log('5. ìŠ¤í‚¤ë§ˆ ê²€ì¦', 'cyan');
  log('0. ì¢…ë£Œ\n', 'cyan');

  const choice = await prompt('ì„ íƒí•˜ì„¸ìš” (0-5): ');

  switch (choice) {
    case '1':
      await checkMigrationStatus();
      break;
    case '2':
      await applyMigrations();
      break;
    case '3':
      await rollbackMigration();
      break;
    case '4':
      await resetDatabase();
      break;
    case '5':
      await checkSchema();
      break;
    case '0':
      log('\nì¢…ë£Œí•©ë‹ˆë‹¤.', 'green');
      process.exit(0);
    default:
      log('ì˜ëª»ëœ ì„ íƒì…ë‹ˆë‹¤', 'red');
  }

  // Show menu again
  await showMenu();
}

async function main() {
  const args = process.argv.slice(2);

  // Direct command execution
  if (args.length > 0) {
    const command = args[0];
    switch (command) {
      case 'status':
        await checkMigrationStatus();
        break;
      case 'up':
        await applyMigrations();
        break;
      case 'down':
        await rollbackMigration();
        break;
      case 'reset':
        await resetDatabase();
        break;
      case 'check':
        await checkSchema();
        break;
      default:
        log(`ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì–´: ${command}`, 'red');
        log('ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´: status, up, down, reset, check', 'yellow');
    }
  } else {
    // Interactive menu
    await showMenu();
  }
}

main().catch(error => {
  log(`\nâŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'red');
  process.exit(1);
});
