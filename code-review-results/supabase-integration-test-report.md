# Supabase 연동 진단 및 웹 테스트 리포트

**생성일**: 2025-10-28  
**진단 항목**: Supabase 연동 상태 및 ERP 재고 관리 기능

## 1. 발견된 문제점

### 1.1 환경변수 이름 불일치
**상태**: ✅ 해결 완료

**문제**:
- `.env` 파일에 중복된 환경변수 존재
  - `SUPABASE_API` vs `NEXT_PUBLIC_SUPABASE_ANON_KEY`
  - `SUPABASE_SERVICE_ROLE` vs `SUPABASE_SERVICE_ROLE_KEY`
- `src/lib/supabase.ts`에서 올바르지 않은 변수명 참조

**수정 내용**:
- `.env` 파일 정리: 불필요한 변수 제거, 표준 변수명만 유지
- `src/lib/supabase.ts` 수정: `process.env.SUPABASE_API` → `process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY`

### 1.2 Companies 테이블 빈 데이터
**상태**: ✅ 해결 완료

**문제**:
- `companies` 테이블에 데이터가 0개
- 매출/구매 거래 생성 시 외래키 제약조건 위반 발생

**수정 내용**:
- Supabase MCP를 통해 테스트용 회사 데이터 2개 생성
  - 고객사: CUS001 - 테스트 고객사 1
  - 공급사: SUP001 - 테스트 공급사 1

## 2. Supabase 연결 상태

### 2.1 프로젝트 정보
- **프로젝트**: TAECHANG_ERP
- **프로젝트 ID**: pybjnkbmtlyaftuiieyq
- **상태**: ACTIVE_HEALTHY ✅
- **지역**: ap-northeast-2 (서울)
- **PostgreSQL**: v17.6.1.021

### 2.2 데이터 현황
- **품목 (items)**: 208개
- **재고 거래 (inventory_transactions)**: 12개
- **회사 (companies)**: 2개 (테스트용 생성)
- **BOM (bom)**: 263개
- **BOM 차감 로그 (bom_deduction_log)**: 38개

## 3. 웹 테스트 결과

### 3.1 재고 현황 페이지 (/stock)
**상태**: ✅ 정상 작동

**테스트 내용**:
1. 페이지 접근: 성공 (HTTP 200)
2. API 호출: `/api/stock` 성공 (HTTP 200)
3. 데이터 표시:
   - 총 품목 수: 208개
   - 재고 부족 품목: 201개
   - 정상 재고 품목: 7개
   - 총 재고 금액: ₩0

**주요 화면 요소**:
- ✅ 상단 통계 카드 (총 품목 수, 재고 부족, 총 재고 금액)
- ✅ 필터링 기능 (검색, 상태별 필터)
- ✅ 재고 현황 테이블 (품번/품명, 규격, 현재고, 단가, 재고금액, 상태)
- ✅ Excel 내보내기 기능

### 3.2 네트워크 요청 분석
**성공한 요청들**:
- `GET /api/stock` - 재고 현황 데이터 조회 (성공)
- `GET /api/auth/me` - 인증 정보 확인 (성공)
- 모든 정적 리소스 로드 (성공)

**데이터 확인**:
- API 응답에 208개 품목 데이터 포함
- 품목별 상세 정보 (item_code, item_name, category, unit, current_stock, etc.)
- 재고 상태 판정 로직 (부족/정상) 정상 작동

## 4. 발견된 추가 이슈

### 4.1 가격 데이터 부재
- 모든 품목의 `price` 필드가 0으로 설정됨
- 총 재고 금액이 ₩0으로 표시됨
- **권장사항**: 가격 데이터 입력 필요

### 4.2 대부분의 품목이 재고 부족 상태
- 201개/208개 품목이 현재고 0개
- 7개 품목만 재고 보유:
  - MOUNTING BRACKET LH: 18,000 EA
  - MOUNTING BRACKET RH: 80 EA
  - GLASS PANEL REINFORCEMENT (50007300D): 200 EA
  - REINFORCEMENT GLASS (50009719C): 200 EA
  - GLASS REINFORCEMENT (50011444F): 2,000 EA
  - GLASS REINFORCEMENT FRONT (50012088E): 200 EA
  - PNL & MBR ASS'Y RR FLR COMPLE 일반 BENCH (65630-L2000): 1,200 EA

### 4.3 과거 에러 로그 분석
**로그 파일**: `logs/error.log`

**주요 오류**:
1. **외래키 위반 오류** (2025-10-25 ~ 2025-10-26)
   - `sales_transactions_customer_id_fkey` 위반
   - companies 테이블 빈 데이터로 인한 오류
   - **상태**: 해결됨 (테스트용 데이터 추가)

2. **날짜 범위 오류** (2025-10-17)
   - `date/time field value out of range: "2025-09-31"`
   - 잘못된 날짜 형식 사용
   - **조치 필요**: 날짜 검증 로직 강화

3. **아이템 조회 실패** (2025-10-14, 10-24)
   - 존재하지 않는 item_id로 접근 시도
   - **조치 필요**: 에러 핸들링 개선

## 5. 권장 사항

### 5.1 즉시 조치 필요
1. **가격 데이터 입력**
   - 품목별 단가 정보 업데이트 필요
   - 현재 총 재고 금액이 0으로 표시됨

2. **재고 입고 데이터 입력**
   - 현재 대부분 품목이 재고 부족 상태
   - 실제 재고 현황 반영 필요

3. **날짜 검증 로직 강화**
   - 존재하지 않는 날짜(예: 9월 31일) 입력 방지
   - 클라이언트/서버 양쪽에서 검증 추가

### 5.2 장기 개선 사항
1. **에러 핸들링 개선**
   - 외래키 위반 시 사용자 친화적 메시지 표시
   - 입력 데이터 사전 검증 강화

2. **데이터 무결성**
   - 필수 데이터 누락 방지
   - 데이터 검증 규칙 강화

3. **로깅 시스템**
   - 에러 로그 실시간 모니터링
   - 알림 시스템 구축

## 6. 테스트 완료 항목

- ✅ Supabase 프로젝트 연결 확인
- ✅ 환경변수 설정 수정
- ✅ 데이터베이스 테이블 조회
- ✅ companies 데이터 추가
- ✅ 재고 현황 페이지 접근
- ✅ API 엔드포인트 호출
- ✅ 데이터 로딩 및 표시

## 결론

Supabase 연동은 정상적으로 작동하고 있으며, ERP 재고 관리 페이지도 올바르게 로드됩니다. 
발견된 문제들(환경변수 불일치, companies 데이터 부재)은 모두 해결되었습니다.
추가로 가격 데이터와 재고 입고 데이터를 입력하면 시스템이 완전히 활용 가능해집니다.
