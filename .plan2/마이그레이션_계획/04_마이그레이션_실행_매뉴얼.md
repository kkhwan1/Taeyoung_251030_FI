# 04. ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ ë§¤ë‰´ì–¼

**ì‘ì„±ì¼**: 2025ë…„ 1ì›”
**ë¬¸ì„œ ëª©ì **: Excel â†’ Supabase ë§ˆì´ê·¸ë ˆì´ì…˜ ë‹¨ê³„ë³„ ì‹¤í–‰ ê°€ì´ë“œ

---

## ğŸ“‹ ì‹¤í–‰ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸

### í™˜ê²½ ì¤€ë¹„

- [ ] Node.js 18+ ì„¤ì¹˜ í™•ì¸
- [ ] npm ì˜ì¡´ì„± ì„¤ì¹˜: `npm install`
- [ ] Supabase í™˜ê²½ ë³€ìˆ˜ ì„¤ì • í™•ì¸ (`.env`)
  ```bash
  NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
  NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
  SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
  SUPABASE_PROJECT_ID=your-project-id
  ```
- [ ] Supabase í”„ë¡œì íŠ¸ ì—°ê²° í™•ì¸: `npm run db:check-schema`
- [ ] Excel íŒŒì¼ ì¤€ë¹„ (`.plan2/ì°¸ê³ /` ë””ë ‰í† ë¦¬)
- [ ] ë°±ì—… ì™„ë£Œ í™•ì¸ (ì¤‘ìš”!)

### ë°±ì—… ì „ëµ

```bash
# 1. Supabase ëŒ€ì‹œë³´ë“œì—ì„œ ìŠ¤ëƒ…ìƒ· ìƒì„±
# Settings â†’ Database â†’ Point-in-time Recovery â†’ Create Snapshot

# 2. ë¡œì»¬ ë°±ì—… (ì„ íƒì‚¬í•­)
npm run db:dump > backup_$(date +%Y%m%d_%H%M%S).sql
```

---

## ğŸš€ ì‹¤í–‰ ë‹¨ê³„

### Phase 0: ì¤€ë¹„ ë‹¨ê³„ (5ë¶„)

#### 0.1 ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ë””ë ‰í† ë¦¬ ìƒì„±

```bash
mkdir -p scripts/migration
cd scripts/migration
```

#### 0.2 í•„ìˆ˜ íŒ¨í‚¤ì§€ í™•ì¸

```bash
# package.jsonì— ì´ë¯¸ í¬í•¨ë˜ì–´ ìˆì–´ì•¼ í•¨
npm list xlsx @supabase/supabase-js
```

#### 0.3 ë§ˆì´ê·¸ë ˆì´ì…˜ ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±

```bash
mkdir -p logs/migration
```

---

### Phase 1: ê¸°ì¡´ ë°ì´í„° ì‚­ì œ (5-10ë¶„)

âš ï¸ **ê²½ê³ **: ì´ ë‹¨ê³„ëŠ” ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë°˜ë“œì‹œ ë°±ì—…ì„ ë¨¼ì € ì™„ë£Œí•˜ì„¸ìš”!

#### 1.1 ì‚­ì œ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±

**íŒŒì¼**: `scripts/migration/01-delete-existing-data.ts`

```typescript
import { createClient } from '@supabase/supabase-js';
import * as fs from 'fs';
import * as path from 'path';

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;
const supabase = createClient(supabaseUrl, supabaseKey);

interface DeletionResult {
  table: string;
  deletedCount: number;
  success: boolean;
  error?: string;
}

const DELETION_ORDER = [
  // ì¢…ì† í…Œì´ë¸”ë¶€í„° ì‚­ì œ (FK ì œì•½ ë•Œë¬¸ì—)
  'inventory_transactions',
  'purchase_transactions',
  'sales_transactions',
  'collections',
  'payments',
  'scrap_tracking',
  'price_master',
  'coil_specs',
  'bom',
  'items',
  'companies',
  'warehouses'
];

async function deleteAllData(): Promise<DeletionResult[]> {
  const results: DeletionResult[] = [];
  const startTime = Date.now();

  console.log('ğŸ—‘ï¸  ê¸°ì¡´ ë°ì´í„° ì‚­ì œ ì‹œì‘...\n');

  for (const table of DELETION_ORDER) {
    console.log(`  - ${table} í…Œì´ë¸” ì‚­ì œ ì¤‘...`);

    try {
      // ë ˆì½”ë“œ ìˆ˜ í™•ì¸
      const { count: beforeCount } = await supabase
        .from(table)
        .select('*', { count: 'exact', head: true });

      if (!beforeCount || beforeCount === 0) {
        console.log(`    âœ… ${table}: ì‚­ì œí•  ë°ì´í„° ì—†ìŒ\n`);
        results.push({
          table,
          deletedCount: 0,
          success: true
        });
        continue;
      }

      // ì „ì²´ ì‚­ì œ
      const { error } = await supabase
        .from(table)
        .delete()
        .neq('id', 0); // ëª¨ë“  ë ˆì½”ë“œ ì‚­ì œ (id != 0 ì¡°ê±´ìœ¼ë¡œ ì „ì²´ ì„ íƒ)

      if (error) {
        console.error(`    âŒ ${table}: ì‚­ì œ ì‹¤íŒ¨ - ${error.message}\n`);
        results.push({
          table,
          deletedCount: 0,
          success: false,
          error: error.message
        });
        continue;
      }

      // ì‚­ì œ í›„ í™•ì¸
      const { count: afterCount } = await supabase
        .from(table)
        .select('*', { count: 'exact', head: true });

      console.log(`    âœ… ${table}: ${beforeCount}ê°œ ì‚­ì œ ì™„ë£Œ (ë‚¨ì€ ë ˆì½”ë“œ: ${afterCount})\n`);

      results.push({
        table,
        deletedCount: beforeCount,
        success: true
      });

    } catch (err) {
      const errorMsg = err instanceof Error ? err.message : String(err);
      console.error(`    âŒ ${table}: ì˜ˆì™¸ ë°œìƒ - ${errorMsg}\n`);
      results.push({
        table,
        deletedCount: 0,
        success: false,
        error: errorMsg
      });
    }
  }

  const duration = Date.now() - startTime;
  const totalDeleted = results.reduce((sum, r) => sum + r.deletedCount, 0);

  console.log('\nğŸ“Š ì‚­ì œ ìš”ì•½:');
  console.log(`  - ì´ ì‚­ì œ ë ˆì½”ë“œ: ${totalDeleted}ê°œ`);
  console.log(`  - ì†Œìš” ì‹œê°„: ${(duration / 1000).toFixed(1)}ì´ˆ`);
  console.log(`  - ì„±ê³µí•œ í…Œì´ë¸”: ${results.filter(r => r.success).length}/${results.length}`);

  // ì‹¤íŒ¨í•œ í…Œì´ë¸” ì¶œë ¥
  const failures = results.filter(r => !r.success);
  if (failures.length > 0) {
    console.log('\nâš ï¸  ì‹¤íŒ¨í•œ í…Œì´ë¸”:');
    failures.forEach(f => {
      console.log(`  - ${f.table}: ${f.error}`);
    });
  }

  // ë¡œê·¸ íŒŒì¼ ì €ì¥
  const logPath = path.join(process.cwd(), 'logs', 'migration', `deletion_${Date.now()}.json`);
  fs.writeFileSync(logPath, JSON.stringify(results, null, 2));
  console.log(`\nğŸ“ ë¡œê·¸ ì €ì¥: ${logPath}`);

  return results;
}

// ì‹¤í–‰
deleteAllData()
  .then(results => {
    const allSuccess = results.every(r => r.success);
    process.exit(allSuccess ? 0 : 1);
  })
  .catch(err => {
    console.error('ì¹˜ëª…ì  ì˜¤ë¥˜:', err);
    process.exit(1);
  });
```

#### 1.2 ì‚­ì œ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰

```bash
# TypeScript ì§ì ‘ ì‹¤í–‰
npx tsx scripts/migration/01-delete-existing-data.ts

# ë˜ëŠ” package.jsonì— ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€ í›„
npm run migrate:delete
```

#### 1.3 ì‚­ì œ í™•ì¸

```bash
# ëª¨ë“  í…Œì´ë¸”ì´ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
npm run db:check-data
```

---

### Phase 2: Excel íŒŒì¼ íŒŒì‹± (10-15ë¶„)

#### 2.1 íŒŒì‹± ìŠ¤í¬ë¦½íŠ¸ ìƒì„±

**íŒŒì¼**: `scripts/migration/02-parse-excel-files.ts`

```typescript
import * as XLSX from 'xlsx';
import * as fs from 'fs';
import * as path from 'path';

interface ParsedData {
  companies: any[];
  items: any[];
  bom: any[];
  coil_specs: any[];
  price_master: any[];
  scrap_tracking: any[];
  inventory_transactions: any[];
  purchase_transactions: any[];
  sales_transactions: any[];
}

const EXCEL_DIR = path.join(process.cwd(), '.plan2', 'ì°¸ê³ ');
const OUTPUT_DIR = path.join(process.cwd(), 'logs', 'migration');

async function parseExcelFiles(): Promise<ParsedData> {
  console.log('ğŸ“‚ Excel íŒŒì¼ íŒŒì‹± ì‹œì‘...\n');

  const parsedData: ParsedData = {
    companies: [],
    items: [],
    bom: [],
    coil_specs: [],
    price_master: [],
    scrap_tracking: [],
    inventory_transactions: [],
    purchase_transactions: [],
    sales_transactions: []
  };

  // 1. BOM íŒŒì¼ íŒŒì‹±
  console.log('  - BOM íŒŒì¼ íŒŒì‹± ì¤‘...');
  const bomPath = path.join(EXCEL_DIR, 'íƒœì°½ê¸ˆì† BOM (1).xlsx');
  const bomData = parseBomFile(bomPath);
  parsedData.bom = bomData.bom;
  parsedData.items.push(...bomData.items);
  parsedData.companies.push(...bomData.companies);
  console.log(`    âœ… BOM: ${parsedData.bom.length}ê°œ ê´€ê³„ íŒŒì‹±`);

  // 2. ë§¤ì…ìˆ˜ë¶ˆ íŒŒì¼ íŒŒì‹±
  console.log('  - ë§¤ì…ìˆ˜ë¶ˆ íŒŒì¼ íŒŒì‹± ì¤‘...');
  const purchasePath = path.join(EXCEL_DIR, '2025ë…„ 09ì›” ë§¤ì… ìˆ˜ë¶ˆê´€ë¦¬ (3).xlsx');
  const purchaseData = parsePurchaseInventoryFile(purchasePath);
  parsedData.items.push(...purchaseData.items);
  parsedData.companies.push(...purchaseData.companies);
  parsedData.coil_specs.push(...purchaseData.coil_specs);
  parsedData.price_master.push(...purchaseData.price_master);
  parsedData.scrap_tracking.push(...purchaseData.scrap_tracking);
  console.log(`    âœ… í’ˆëª©: ${purchaseData.items.length}ê°œ íŒŒì‹±`);

  // 3. ì¢…í•©ê´€ë¦¬ íŒŒì¼ íŒŒì‹± (ì¬ê³  ê±°ë˜)
  console.log('  - ì¢…í•©ê´€ë¦¬ íŒŒì¼ íŒŒì‹± ì¤‘...');
  const inventoryPath = path.join(EXCEL_DIR, '2025ë…„ 9ì›” 19ì¼ ì¢…í•©ê´€ë¦¬ SHEET (1).xlsx');
  const inventoryData = parseInventoryFile(inventoryPath);
  parsedData.inventory_transactions = inventoryData.transactions;
  console.log(`    âœ… ì¬ê³ ê±°ë˜: ${parsedData.inventory_transactions.length}ê°œ íŒŒì‹±`);

  // 4. ë§¤ì…ë§¤ì¶œ íŒŒì¼ íŒŒì‹±
  console.log('  - ë§¤ì…ë§¤ì¶œ íŒŒì¼ íŒŒì‹± ì¤‘...');
  const salesPurchasePath = path.join(EXCEL_DIR, '2025ë…„ 9ì›” ë§¤ì…ë§¤ì¶œ ë³´ê³ í˜„í™© (1).xlsx');
  const salesPurchaseData = parseSalesPurchaseFile(salesPurchasePath);
  parsedData.purchase_transactions = salesPurchaseData.purchases;
  parsedData.sales_transactions = salesPurchaseData.sales;
  console.log(`    âœ… ë§¤ì…: ${parsedData.purchase_transactions.length}ê°œ íŒŒì‹±`);
  console.log(`    âœ… ë§¤ì¶œ: ${parsedData.sales_transactions.length}ê°œ íŒŒì‹±`);

  // ì¤‘ë³µ ì œê±° (companies, items)
  console.log('\n  - ì¤‘ë³µ ë°ì´í„° ì œê±° ì¤‘...');
  parsedData.companies = deduplicateCompanies(parsedData.companies);
  parsedData.items = deduplicateItems(parsedData.items);
  console.log(`    âœ… ê±°ë˜ì²˜: ${parsedData.companies.length}ê°œ (ì¤‘ë³µ ì œê±° í›„)`);
  console.log(`    âœ… í’ˆëª©: ${parsedData.items.length}ê°œ (ì¤‘ë³µ ì œê±° í›„)`);

  // ê²°ê³¼ ì €ì¥
  const outputPath = path.join(OUTPUT_DIR, `parsed_data_${Date.now()}.json`);
  fs.writeFileSync(outputPath, JSON.stringify(parsedData, null, 2));
  console.log(`\nğŸ“ íŒŒì‹± ê²°ê³¼ ì €ì¥: ${outputPath}`);

  return parsedData;
}

function parseBomFile(filePath: string): { bom: any[]; items: any[]; companies: any[] } {
  const workbook = XLSX.readFile(filePath);
  const bom: any[] = [];
  const items: any[] = [];
  const companies: any[] = [];

  // ê° ì‹œíŠ¸ëŠ” ê³ ê°ì‚¬ë³„ BOM
  for (const sheetName of workbook.SheetNames) {
    const sheet = workbook.Sheets[sheetName];
    const rows: any[] = XLSX.utils.sheet_to_json(sheet);

    // ê³ ê°ì‚¬ ì •ë³´ ì¶”ì¶œ
    if (rows.length > 0 && rows[0].ê³ ê°ëª…) {
      companies.push({
        company_code: `CUS_${sheetName.replace(/[^a-zA-Z0-9]/g, '_').toUpperCase()}`,
        company_name: rows[0].ê³ ê°ëª…,
        company_type: 'ê³ ê°ì‚¬'
      });
    }

    // BOM ê´€ê³„ íŒŒì‹±
    for (const row of rows) {
      if (!row.í’ˆë²ˆ || !row.ì‚¬ìš©ì¬ì§ˆí’ˆë²ˆ) continue;

      // ì™„ì œí’ˆ (parent)
      items.push({
        item_code: row.í’ˆë²ˆ,
        item_name: row.í’ˆëª… || row.í’ˆë²ˆ,
        category: 'ì œí’ˆ',
        spec: row.ê·œê²© || '',
        unit: 'EA'
      });

      // ì›ìì¬ (child)
      items.push({
        item_code: row.ì‚¬ìš©ì¬ì§ˆí’ˆë²ˆ,
        item_name: row.ì‚¬ìš©ì¬ì§ˆí’ˆëª… || row.ì‚¬ìš©ì¬ì§ˆí’ˆë²ˆ,
        category: 'ì›ìì¬',
        spec: row.ì‚¬ìš©ì¬ì§ˆê·œê²© || '',
        unit: 'KG'
      });

      // BOM ê´€ê³„
      bom.push({
        parent_item_code: row.í’ˆë²ˆ,
        child_item_code: row.ì‚¬ìš©ì¬ì§ˆí’ˆë²ˆ,
        quantity_required: parseFloat(row.ì†Œìš”ëŸ‰ || 1),
        level_no: 2 // 2ë‹¨ê³„ BOM
      });
    }
  }

  return { bom, items, companies };
}

function parsePurchaseInventoryFile(filePath: string): {
  items: any[];
  companies: any[];
  coil_specs: any[];
  price_master: any[];
  scrap_tracking: any[];
} {
  const workbook = XLSX.readFile(filePath);
  const items: any[] = [];
  const companies: any[] = [];
  const coil_specs: any[] = [];
  const price_master: any[] = [];
  const scrap_tracking: any[] = [];

  // "ë§¤ì…ìˆ˜ë¶ˆ" ì‹œíŠ¸ íŒŒì‹±
  if (workbook.SheetNames.includes('ë§¤ì…ìˆ˜ë¶ˆ')) {
    const sheet = workbook.Sheets['ë§¤ì…ìˆ˜ë¶ˆ'];
    const rows: any[] = XLSX.utils.sheet_to_json(sheet);

    for (const row of rows) {
      if (!row.í’ˆëª…) continue;

      // í’ˆëª© ì •ë³´
      const itemCode = generateItemCode(row.í’ˆëª…, row.ê·œê²©);
      items.push({
        item_code: itemCode,
        item_name: row.í’ˆëª…,
        category: classifyItemCategory(row.í’ˆëª…),
        spec: row.ê·œê²© || '',
        material: row.ì¬ì§ˆ || '',
        thickness: parseFloat(row.ë‘ê»˜) || null,
        width: parseFloat(row.í­) || null,
        unit: row.ë‹¨ìœ„ || 'EA'
      });

      // ê³µê¸‰ì‚¬ ì •ë³´
      if (row.ê³µê¸‰ì‚¬) {
        companies.push({
          company_code: `SUP_${row.ê³µê¸‰ì‚¬.replace(/[^a-zA-Z0-9]/g, '_').toUpperCase()}`,
          company_name: row.ê³µê¸‰ì‚¬,
          company_type: 'ê³µê¸‰ì‚¬'
        });
      }

      // COIL Specs (ì›ìì¬ë§Œ)
      if (row.ì¬ì§ˆ && row.ë‘ê»˜ && row.í­ && row.ê¸¸ì´) {
        coil_specs.push({
          item_code: itemCode,
          material_grade: row.ì¬ì§ˆ,
          thickness: parseFloat(row.ë‘ê»˜),
          width: parseFloat(row.í­),
          length: parseFloat(row.ê¸¸ì´),
          sep_factor: parseFloat(row.SEP) || 1,
          density: parseFloat(row.ë¹„ì¤‘) || 7.85,
          kg_unit_price: parseFloat(row.KGë‹¨ê°€) || null
        });
      }

      // ê°€ê²© ì •ë³´
      if (row.ë‹¨ê°€) {
        price_master.push({
          item_code: itemCode,
          unit_price: parseFloat(row.ë‹¨ê°€),
          effective_date: '2025-01-01'
        });
      }

      // ìŠ¤í¬ë© ì •ë³´
      if (row.ìŠ¤í¬ë©ì¤‘ëŸ‰ && row.ìŠ¤í¬ë©ë‹¨ê°€) {
        scrap_tracking.push({
          item_code: itemCode,
          production_date: new Date().toISOString().split('T')[0],
          production_quantity: parseFloat(row.ì‹¤ì ìˆ˜ëŸ‰) || 0,
          scrap_weight_per_unit: parseFloat(row.ìŠ¤í¬ë©ì¤‘ëŸ‰),
          scrap_unit_price: parseFloat(row.ìŠ¤í¬ë©ë‹¨ê°€)
        });
      }
    }
  }

  return { items, companies, coil_specs, price_master, scrap_tracking };
}

function parseInventoryFile(filePath: string): { transactions: any[] } {
  const workbook = XLSX.readFile(filePath);
  const transactions: any[] = [];

  // "ì…ê³ ", "ì¶œê³ ", "ìƒì‚°ì…ê³ " ì‹œíŠ¸ íŒŒì‹±
  const sheetTypes = [
    { name: 'ì…ê³ ', type: 'ì…ê³ ' },
    { name: 'ì¶œê³ ', type: 'ì¶œê³ ' },
    { name: 'ìƒì‚°ì…ê³ ', type: 'ìƒì‚°ì…ê³ ' }
  ];

  for (const { name: sheetName, type: txType } of sheetTypes) {
    if (!workbook.SheetNames.includes(sheetName)) continue;

    const sheet = workbook.Sheets[sheetName];
    const rows: any[] = XLSX.utils.sheet_to_json(sheet);

    for (const row of rows) {
      if (!row.í’ˆëª…) continue;

      const itemCode = generateItemCode(row.í’ˆëª…, row.ê·œê²©);

      // T1~T268 ì»¬ëŸ¼ íŒŒì‹± (268ì¼ì¹˜ ì¼ë³„ ë°ì´í„°)
      for (let day = 1; day <= 268; day++) {
        const colName = `T${day}`;
        const quantity = parseFloat(row[colName]);

        if (!quantity || quantity === 0) continue;

        const transactionDate = new Date('2025-01-01');
        transactionDate.setDate(transactionDate.getDate() + day - 1);

        transactions.push({
          item_code: itemCode,
          transaction_type: txType,
          quantity: Math.abs(quantity),
          transaction_date: transactionDate.toISOString().split('T')[0],
          status: 'ì™„ë£Œ'
        });
      }
    }
  }

  return { transactions };
}

function parseSalesPurchaseFile(filePath: string): {
  purchases: any[];
  sales: any[];
} {
  const workbook = XLSX.readFile(filePath);
  const purchases: any[] = [];
  const sales: any[] = [];

  // "ë§¤ì…" ì‹œíŠ¸
  if (workbook.SheetNames.includes('ë§¤ì…')) {
    const sheet = workbook.Sheets['ë§¤ì…'];
    const rows: any[] = XLSX.utils.sheet_to_json(sheet);

    for (const row of rows) {
      if (!row.í’ˆëª… || !row.ê±°ë˜ì²˜) continue;

      purchases.push({
        transaction_date: parseExcelDate(row.ê±°ë˜ì¼ì),
        company_code: `SUP_${row.ê±°ë˜ì²˜.replace(/[^a-zA-Z0-9]/g, '_').toUpperCase()}`,
        item_code: generateItemCode(row.í’ˆëª…, row.ê·œê²©),
        quantity: parseFloat(row.ìˆ˜ëŸ‰) || 0,
        unit_price: parseFloat(row.ë‹¨ê°€) || 0,
        total_amount: parseFloat(row.ê¸ˆì•¡) || 0,
        payment_status: 'PENDING'
      });
    }
  }

  // "ë§¤ì¶œ" ì‹œíŠ¸
  if (workbook.SheetNames.includes('ë§¤ì¶œ')) {
    const sheet = workbook.Sheets['ë§¤ì¶œ'];
    const rows: any[] = XLSX.utils.sheet_to_json(sheet);

    for (const row of rows) {
      if (!row.í’ˆëª… || !row.ê±°ë˜ì²˜) continue;

      sales.push({
        transaction_date: parseExcelDate(row.ê±°ë˜ì¼ì),
        company_code: `CUS_${row.ê±°ë˜ì²˜.replace(/[^a-zA-Z0-9]/g, '_').toUpperCase()}`,
        item_code: generateItemCode(row.í’ˆëª…, row.ê·œê²©),
        quantity: parseFloat(row.ìˆ˜ëŸ‰) || 0,
        unit_price: parseFloat(row.ë‹¨ê°€) || 0,
        total_amount: parseFloat(row.ê¸ˆì•¡) || 0,
        payment_status: 'PENDING'
      });
    }
  }

  return { purchases, sales };
}

// í—¬í¼ í•¨ìˆ˜ë“¤
function generateItemCode(name: string, spec?: string): string {
  const cleanName = name.replace(/[^a-zA-Z0-9ê°€-í£]/g, '');
  const cleanSpec = spec ? spec.replace(/[^a-zA-Z0-9]/g, '') : '';
  return `ITEM_${cleanName}_${cleanSpec}`.slice(0, 50).toUpperCase();
}

function classifyItemCategory(name: string): string {
  if (name.includes('COIL') || name.includes('ì½”ì¼')) return 'ì›ìì¬';
  if (name.includes('SHEET') || name.includes('ì‰¬íŠ¸')) return 'ë°˜ì œí’ˆ';
  return 'ì œí’ˆ';
}

function parseExcelDate(value: any): string {
  if (value instanceof Date) {
    return value.toISOString().split('T')[0];
  }
  if (typeof value === 'number') {
    const date = new Date((value - 25569) * 86400 * 1000);
    return date.toISOString().split('T')[0];
  }
  if (typeof value === 'string') {
    return new Date(value).toISOString().split('T')[0];
  }
  return new Date().toISOString().split('T')[0];
}

function deduplicateCompanies(companies: any[]): any[] {
  const map = new Map();
  for (const company of companies) {
    if (!map.has(company.company_code)) {
      map.set(company.company_code, company);
    }
  }
  return Array.from(map.values());
}

function deduplicateItems(items: any[]): any[] {
  const map = new Map();
  for (const item of items) {
    if (!map.has(item.item_code)) {
      map.set(item.item_code, item);
    }
  }
  return Array.from(map.values());
}

// ì‹¤í–‰
parseExcelFiles()
  .then(data => {
    console.log('\nâœ… Excel íŒŒì¼ íŒŒì‹± ì™„ë£Œ!');
    console.log('\nğŸ“Š íŒŒì‹± ê²°ê³¼ ìš”ì•½:');
    console.log(`  - ê±°ë˜ì²˜: ${data.companies.length}ê°œ`);
    console.log(`  - í’ˆëª©: ${data.items.length}ê°œ`);
    console.log(`  - BOM: ${data.bom.length}ê°œ`);
    console.log(`  - COIL Specs: ${data.coil_specs.length}ê°œ`);
    console.log(`  - ê°€ê²© ì •ë³´: ${data.price_master.length}ê°œ`);
    console.log(`  - ìŠ¤í¬ë© ì¶”ì : ${data.scrap_tracking.length}ê°œ`);
    console.log(`  - ì¬ê³  ê±°ë˜: ${data.inventory_transactions.length}ê°œ`);
    console.log(`  - ë§¤ì… ê±°ë˜: ${data.purchase_transactions.length}ê°œ`);
    console.log(`  - ë§¤ì¶œ ê±°ë˜: ${data.sales_transactions.length}ê°œ`);
    process.exit(0);
  })
  .catch(err => {
    console.error('ì¹˜ëª…ì  ì˜¤ë¥˜:', err);
    process.exit(1);
  });
```

#### 2.2 íŒŒì‹± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰

```bash
npx tsx scripts/migration/02-parse-excel-files.ts
```

#### 2.3 íŒŒì‹± ê²°ê³¼ ê²€í† 

```bash
# ìƒì„±ëœ JSON íŒŒì¼ í™•ì¸
cat logs/migration/parsed_data_*.json | jq '.companies | length'
cat logs/migration/parsed_data_*.json | jq '.items | length'
```

---

### Phase 3: ë°ì´í„° ê²€ì¦ (10-15ë¶„)

#### 3.1 ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰

```bash
npx tsx scripts/migration/03-validate-data.ts logs/migration/parsed_data_*.json
```

**ì¶œë ¥ ì˜ˆì‹œ**:
```
ğŸ” Phase 1: ê¸°ë³¸ ë°ì´í„° ê²€ì¦ ì‹œì‘...
  âœ… Phase 1 ì™„ë£Œ: 3ê°œ ì˜¤ë¥˜ ë°œê²¬

ğŸ” Phase 2: ì°¸ì¡° ë¬´ê²°ì„± ê²€ì¦ ì‹œì‘...
  âœ… Phase 2 ì™„ë£Œ: 12ê°œ ì˜¤ë¥˜ ë°œê²¬

ğŸ” Phase 3: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ê²€ì¦ ì‹œì‘...
  âœ… Phase 3 ì™„ë£Œ: 5ê°œ ì˜¤ë¥˜ ë°œê²¬

ğŸ” Phase 4: í†µê³„ ê²€ì¦ ì‹œì‘...
  âœ… Phase 4 ì™„ë£Œ: 0ê°œ ì˜¤ë¥˜ ë°œê²¬

â±ï¸ ì „ì²´ ê²€ì¦ ì™„ë£Œ: 8.3ì´ˆ

ğŸ“Š ê²€ì¦ ìš”ì•½:
  - ì´ ì˜¤ë¥˜ ìˆ˜: 20ê°œ
  - ì¹˜ëª…ì  ì˜¤ë¥˜: 8ê°œ
```

#### 3.2 ê²€ì¦ ë¦¬í¬íŠ¸ í™•ì¸

```bash
cat logs/migration/validation_report_*.md
```

#### 3.3 ì˜¤ë¥˜ ìˆ˜ì •

- **Critical ì˜¤ë¥˜**: Excel íŒŒì¼ ìˆ˜ì • í›„ Phase 2ë¶€í„° ì¬ì‹¤í–‰
- **Warning ì˜¤ë¥˜**: ë¡œê·¸ ê¸°ë¡í•˜ê³  ê³„ì† ì§„í–‰

---

### Phase 4: ë§ˆìŠ¤í„° ë°ì´í„° ì„í¬íŠ¸ (15-20ë¶„)

#### 4.1 ê±°ë˜ì²˜ ì„í¬íŠ¸

```bash
npx tsx scripts/migration/04-import-companies.ts logs/migration/parsed_data_*.json
```

**ì§„í–‰ ìƒí™©**:
```
ğŸ“¥ ê±°ë˜ì²˜ ì„í¬íŠ¸ ì‹œì‘...
  â³ [=====>    ] 50/120 (41.7%) - CUS_ì‚¼ì„±ì „ì
  â³ [========>] 100/120 (83.3%) - SUP_í˜„ëŒ€ì œì² 
âœ… ê±°ë˜ì²˜ ì„í¬íŠ¸ ì™„ë£Œ: 120ê°œ (5.2ì´ˆ)
```

#### 4.2 í’ˆëª© ì„í¬íŠ¸

```bash
npx tsx scripts/migration/05-import-items.ts logs/migration/parsed_data_*.json
```

**ì§„í–‰ ìƒí™©**:
```
ğŸ“¥ í’ˆëª© ì„í¬íŠ¸ ì‹œì‘...
  â³ [====>     ] 250/580 (43.1%) - ITEM_COIL_CR_01
  â³ [========>] 500/580 (86.2%) - ITEM_SHEET_SPHC_02
âœ… í’ˆëª© ì„í¬íŠ¸ ì™„ë£Œ: 580ê°œ (12.4ì´ˆ)
```

#### 4.3 BOM ì„í¬íŠ¸

```bash
npx tsx scripts/migration/06-import-bom.ts logs/migration/parsed_data_*.json
```

#### 4.4 COIL Specs ì„í¬íŠ¸

```bash
npx tsx scripts/migration/07-import-coil-specs.ts logs/migration/parsed_data_*.json
```

---

### Phase 5: ê±°ë˜ ë°ì´í„° ì„í¬íŠ¸ (20-30ë¶„)

#### 5.1 ì¬ê³  ê±°ë˜ ì„í¬íŠ¸

```bash
npx tsx scripts/migration/08-import-inventory-transactions.ts logs/migration/parsed_data_*.json
```

**ì§„í–‰ ìƒí™©**:
```
ğŸ“¥ ì¬ê³  ê±°ë˜ ì„í¬íŠ¸ ì‹œì‘...
  â³ [===>      ] 2,500/8,950 (27.9%) - ì…ê³ 
  â³ [======>   ] 5,000/8,950 (55.9%) - ì¶œê³ 
  â³ [========>] 8,000/8,950 (89.4%) - ìƒì‚°ì…ê³ 
âœ… ì¬ê³  ê±°ë˜ ì„í¬íŠ¸ ì™„ë£Œ: 8,950ê°œ (24.7ì´ˆ)
```

#### 5.2 ë§¤ì…/ë§¤ì¶œ ê±°ë˜ ì„í¬íŠ¸

```bash
npx tsx scripts/migration/09-import-purchase-sales.ts logs/migration/parsed_data_*.json
```

#### 5.3 ê°€ê²© ì •ë³´ ì„í¬íŠ¸

```bash
npx tsx scripts/migration/10-import-price-master.ts logs/migration/parsed_data_*.json
```

#### 5.4 ìŠ¤í¬ë© ì¶”ì  ì„í¬íŠ¸

```bash
npx tsx scripts/migration/11-import-scrap-tracking.ts logs/migration/parsed_data_*.json
```

---

### Phase 6: ìµœì¢… ê²€ì¦ (10-15ë¶„)

#### 6.1 ë ˆì½”ë“œ ìˆ˜ ê²€ì¦

```bash
npm run db:check-data
```

**ì˜ˆìƒ ì¶œë ¥**:
```
âœ… companies: 120ê°œ
âœ… items: 580ê°œ
âœ… bom: 350ê°œ
âœ… coil_specs: 180ê°œ
âœ… price_master: 420ê°œ
âœ… scrap_tracking: 230ê°œ
âœ… inventory_transactions: 8,950ê°œ
âœ… purchase_transactions: 2,450ê°œ
âœ… sales_transactions: 3,120ê°œ
```

#### 6.2 ì°¸ì¡° ë¬´ê²°ì„± ê²€ì¦

```bash
npx tsx scripts/migration/12-verify-integrity.ts
```

**ê²€ì¦ í•­ëª©**:
- [ ] ëª¨ë“  items.supplier_idê°€ companiesì— ì¡´ì¬
- [ ] ëª¨ë“  bom FKê°€ itemsì— ì¡´ì¬
- [ ] ëª¨ë“  ê±°ë˜ item_idê°€ itemsì— ì¡´ì¬
- [ ] ìˆœí™˜ ì°¸ì¡° ì—†ìŒ
- [ ] ì¬ê³  ìŒìˆ˜ ì—†ìŒ

#### 6.3 ê³„ì‚° ê²€ì¦

```bash
npx tsx scripts/migration/13-verify-calculations.ts
```

**ê²€ì¦ í•­ëª©**:
- [ ] COIL EAì¤‘ëŸ‰ ê³„ì‚° ì¼ì¹˜
- [ ] COIL EAë‹¨ê°€ ê³„ì‚° ì¼ì¹˜
- [ ] ìŠ¤í¬ë©ê¸ˆì•¡ ê³„ì‚° ì¼ì¹˜
- [ ] ê±°ë˜ í•©ê³„ ê¸ˆì•¡ ì¼ì¹˜

---

## ğŸ“Š ì‹¤í–‰ ê²°ê³¼ ë³´ê³ ì„œ

### ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] Phase 0: ì¤€ë¹„ ë‹¨ê³„ ì™„ë£Œ
- [ ] Phase 1: ê¸°ì¡´ ë°ì´í„° ì‚­ì œ ì™„ë£Œ
- [ ] Phase 2: Excel íŒŒì‹± ì™„ë£Œ (120 companies, 580 items)
- [ ] Phase 3: ë°ì´í„° ê²€ì¦ ì™„ë£Œ (Critical ì˜¤ë¥˜ 0ê°œ)
- [ ] Phase 4: ë§ˆìŠ¤í„° ë°ì´í„° ì„í¬íŠ¸ ì™„ë£Œ (1,050ê°œ)
- [ ] Phase 5: ê±°ë˜ ë°ì´í„° ì„í¬íŠ¸ ì™„ë£Œ (14,750ê°œ)
- [ ] Phase 6: ìµœì¢… ê²€ì¦ ì™„ë£Œ (ë¬´ê²°ì„± 100%)
- [ ] í”„ë¡ íŠ¸ì—”ë“œ ë™ì‘ í™•ì¸ (http://localhost:5000)
- [ ] ìƒ˜í”Œ ì¿¼ë¦¬ í…ŒìŠ¤íŠ¸ ì™„ë£Œ

### ì˜ˆìƒ ì†Œìš” ì‹œê°„

| Phase | ì‘ì—… | ì˜ˆìƒ ì‹œê°„ |
|-------|------|----------|
| 0 | ì¤€ë¹„ | 5ë¶„ |
| 1 | ê¸°ì¡´ ë°ì´í„° ì‚­ì œ | 5-10ë¶„ |
| 2 | Excel íŒŒì‹± | 10-15ë¶„ |
| 3 | ë°ì´í„° ê²€ì¦ | 10-15ë¶„ |
| 4 | ë§ˆìŠ¤í„° ë°ì´í„° ì„í¬íŠ¸ | 15-20ë¶„ |
| 5 | ê±°ë˜ ë°ì´í„° ì„í¬íŠ¸ | 20-30ë¶„ |
| 6 | ìµœì¢… ê²€ì¦ | 10-15ë¶„ |
| **í•©ê³„** | | **75-110ë¶„** |

---

## ğŸš¨ ë¬¸ì œ í•´ê²°

### ë¬¸ì œ 1: Excel íŒŒì¼ ì½ê¸° ì‹¤íŒ¨

**ì¦ìƒ**: `Error: Cannot read file`

**í•´ê²°ì±…**:
```bash
# íŒŒì¼ ê²½ë¡œ í™•ì¸
ls -la .plan2/ì°¸ê³ /*.xlsx

# íŒŒì¼ ê¶Œí•œ í™•ì¸
chmod 644 .plan2/ì°¸ê³ /*.xlsx

# íŒŒì¼ ì´ë¦„ì— íŠ¹ìˆ˜ë¬¸ì ìˆìœ¼ë©´ ì´ìŠ¤ì¼€ì´í”„
```

### ë¬¸ì œ 2: Supabase ì—°ê²° ì‹¤íŒ¨

**ì¦ìƒ**: `Error: Invalid API key`

**í•´ê²°ì±…**:
```bash
# .env íŒŒì¼ í™•ì¸
cat .env | grep SUPABASE

# í™˜ê²½ ë³€ìˆ˜ ì¬ë¡œë“œ
source .env

# Supabase í”„ë¡œì íŠ¸ ìƒíƒœ í™•ì¸ (Dashboard)
```

### ë¬¸ì œ 3: FK ì œì•½ ìœ„ë°˜

**ì¦ìƒ**: `Error: Foreign key constraint failed`

**í•´ê²°ì±…**:
```typescript
// ì„í¬íŠ¸ ìˆœì„œ í™•ì¸ (ë¶€ëª¨ í…Œì´ë¸” ë¨¼ì €)
1. companies
2. items
3. bom (items ì´í›„)
4. transactions (items, companies ì´í›„)

// FK ì œì•½ ì¼ì‹œ ë¹„í™œì„±í™” (ê¶Œì¥í•˜ì§€ ì•ŠìŒ)
// SET session_replication_role = 'replica';
// ... ë°ì´í„° ì„í¬íŠ¸
// SET session_replication_role = 'origin';
```

### ë¬¸ì œ 4: ë©”ëª¨ë¦¬ ë¶€ì¡±

**ì¦ìƒ**: `JavaScript heap out of memory`

**í•´ê²°ì±…**:
```bash
# Node.js ë©”ëª¨ë¦¬ ì¦ê°€
NODE_OPTIONS=--max-old-space-size=4096 npx tsx script.ts

# ë˜ëŠ” ë°°ì¹˜ ì²˜ë¦¬ í¬ê¸° ì¤„ì´ê¸°
const BATCH_SIZE = 100; // 1000 â†’ 100
```

### ë¬¸ì œ 5: íƒ€ì„ì•„ì›ƒ

**ì¦ìƒ**: `Error: Timeout waiting for response`

**í•´ê²°ì±…**:
```typescript
// Supabase í´ë¼ì´ì–¸íŠ¸ íƒ€ì„ì•„ì›ƒ ì¦ê°€
const supabase = createClient(url, key, {
  db: {
    schema: 'public'
  },
  global: {
    fetch: (url, options) => {
      return fetch(url, {
        ...options,
        timeout: 60000 // 60ì´ˆ
      });
    }
  }
});
```

---

## ğŸ“ ë¡¤ë°± ì ˆì°¨

### ì¦‰ì‹œ ë¡¤ë°± (Phase 1-3 ì‹¤íŒ¨ ì‹œ)

```bash
# ì´ë¯¸ ì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬ ë¶ˆê°€
# Supabase ìŠ¤ëƒ…ìƒ·ì—ì„œ ë³µì›
# Settings â†’ Database â†’ Backups â†’ Restore
```

### ë¶€ë¶„ ë¡¤ë°± (Phase 4-6 ì‹¤íŒ¨ ì‹œ)

```bash
# ì‹¤íŒ¨í•œ Phaseë¶€í„° ì¬ì‹œì‘
# ì˜ˆ: Phase 5 ì‹¤íŒ¨ ì‹œ

# 1. Phase 5 ê´€ë ¨ ë°ì´í„°ë§Œ ì‚­ì œ
npx tsx scripts/migration/rollback-phase5.ts

# 2. Phase 5ë¶€í„° ì¬ì‹¤í–‰
npx tsx scripts/migration/08-import-inventory-transactions.ts
```

---

## âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì„±ê³µ í™•ì¸

### 1. í”„ë¡ íŠ¸ì—”ë“œ ì ‘ì†

```bash
npm run dev:safe
# http://localhost:5000 ì ‘ì†
```

### 2. ëŒ€ì‹œë³´ë“œ í™•ì¸

- [ ] í†µê³„ ì¹´ë“œì— ì‹¤ì œ ë°ì´í„° í‘œì‹œ
- [ ] ì°¨íŠ¸ì— ì‹¤ì œ ë°ì´í„° í‘œì‹œ
- [ ] ì•Œë¦¼ íŒ¨ë„ ì •ìƒ ì‘ë™

### 3. ë§ˆìŠ¤í„° ë°ì´í„° ì¡°íšŒ

- [ ] ê±°ë˜ì²˜ ëª©ë¡ ì •ìƒ ì¡°íšŒ
- [ ] í’ˆëª© ëª©ë¡ ì •ìƒ ì¡°íšŒ
- [ ] BOM ëª©ë¡ ì •ìƒ ì¡°íšŒ

### 4. ê±°ë˜ ë°ì´í„° ì¡°íšŒ

- [ ] ì¬ê³  ê±°ë˜ ë‚´ì—­ ì •ìƒ ì¡°íšŒ
- [ ] ë§¤ì…/ë§¤ì¶œ ê±°ë˜ ì •ìƒ ì¡°íšŒ
- [ ] ìˆ˜ê¸ˆ/ì§€ê¸‰ ì •ìƒ ì¡°íšŒ (ìˆëŠ” ê²½ìš°)

### 5. Excel ë‚´ë³´ë‚´ê¸° í…ŒìŠ¤íŠ¸

- [ ] ì¬ê³  ë‚´ë³´ë‚´ê¸° ì •ìƒ ì‘ë™
- [ ] ë§¤ì¶œ ë‚´ë³´ë‚´ê¸° ì •ìƒ ì‘ë™
- [ ] ë§¤ì… ë‚´ë³´ë‚´ê¸° ì •ìƒ ì‘ë™

---

**ë¬¸ì„œ ì™„ë£Œ** | ë‹¤ìŒ: [05_ë¬¸ì œ_í•´ê²°_ê°€ì´ë“œ.md](./05_ë¬¸ì œ_í•´ê²°_ê°€ì´ë“œ.md)
