# 데이터 마이그레이션 마스터 플랜

## 📋 프로젝트 개요

**목적**: 테스트 데이터를 삭제하고 실제 운영 데이터(Excel)를 Supabase 데이터베이스로 마이그레이션

**작성일**: 2025-01-16
**예상 총 소요시간**: 1시간 10분 ~ 1시간 40분
**위험도**: 중간 (백업 및 롤백 계획 필수)

---

## 📊 데이터 볼륨 분석

### Excel 소스 파일

| 파일명 | 크기 | 예상 행 수 | 주요 내용 |
|--------|------|-----------|----------|
| 태창금속 BOM (1).xlsx | 537 KB | 4,252 | BOM 관계 (5개 고객사) |
| 2025년 9월 19일 종합관리 SHEET (1).xlsx | 643 KB | 1,303 | 재고 거래 (268일 시계열) |
| 2025년 9월 매입매출 보고현황 (1).xlsx | 2.2 MB | ~2,000 | 매입/매출 거래 |
| 2025년 09월 매입 수불관리 (3).xlsx | 16.7 MB | ~5,000 | 상세 매입 수불 |

**총 예상 레코드**: 약 12,500+ 행

### 데이터베이스 대상 테이블

| 테이블명 | 예상 레코드 수 | 우선순위 | 비고 |
|---------|--------------|---------|------|
| companies | ~50 | 1 | 거래처 마스터 |
| items | ~450 | 1 | 품목 마스터 |
| bom | 4,252 | 2 | BOM 관계 (2-레벨) |
| coil_specs | ~100 | 2 | 내부 생산 스펙 |
| price_master | ~300 | 2 | 단가표 |
| scrap_tracking | ~200 | 2 | 스크랩 추적 |
| inventory_transactions | ~6,000 | 3 | 재고 거래 |
| purchase_transactions | ~3,000 | 3 | 매입 거래 |
| sales_transactions | ~1,500 | 3 | 매출 거래 |
| collections | TBD | 4 | 수금 (추후) |
| payments | TBD | 4 | 지급 (추후) |

---

## ⏱️ 상세 작업 일정

### Phase 1: 준비 및 백업 (7-10분)

#### 1.1 현재 데이터 백업 (5분)
- **작업**: 모든 테이블 데이터를 JSON 형식으로 백업
- **저장 위치**: `backups/test-data-backup-[timestamp].json`
- **백업 대상**:
  - companies (거래처)
  - items (품목)
  - bom (BOM)
  - coil_specs, price_master, scrap_tracking
  - inventory_transactions
  - purchase_transactions, sales_transactions
  - collections, payments

#### 1.2 Excel 파일 검증 (2-3분)
- **검증 항목**:
  - 파일 존재 여부
  - 파일 읽기 가능 여부
  - 시트 구조 확인
  - 필수 컬럼 존재 여부

#### 1.3 데이터 삭제 계획 수립 (2분)
- **삭제 순서** (FK 제약조건 역순):
  1. collections, payments
  2. inventory_transactions
  3. purchase_transactions, sales_transactions
  4. scrap_tracking
  5. price_master
  6. bom, coil_specs
  7. items
  8. companies

### Phase 2: 테스트 데이터 삭제 (2-3분)

#### 2.1 FK 제약조건 확인 (30초)
```sql
SELECT
  conname AS constraint_name,
  conrelid::regclass AS table_name,
  confrelid::regclass AS referenced_table
FROM pg_constraint
WHERE contype = 'f'
ORDER BY conrelid::regclass::text;
```

#### 2.2 순차적 데이터 삭제 (2분)
- **방법**: `DELETE FROM` 또는 `TRUNCATE CASCADE`
- **검증**: 각 단계 후 레코드 수 확인

### Phase 3: Excel 파싱 및 데이터 정제 (15-20분)

#### 3.1 BOM 파일 파싱 (8-10분)
- **파일**: 태창금속 BOM (1).xlsx
- **시트**:
  - 최신단가 (단가 마스터 + 거래처)
  - 대우공업, 풍기산업, 다인, 호원오토, 인알파코리아 (BOM 데이터)
- **변환 작업**:
  - 컬럼명 한글 → 영문 매핑
  - 수식 계산 → 실제 값
  - 중복 품목 통합
  - NULL/빈 값 처리

#### 3.2 재고 관리 파일 파싱 (5-7분)
- **파일**: 2025년 9월 19일 종합관리 SHEET (1).xlsx
- **시트**: 종합재고, COIL 입고현황, SHEET 입고현황, 생산실적
- **변환 작업**:
  - 268개 일별 컬럼 → 개별 거래 레코드 변환
  - 거래 유형 분류 (입고/출고/생산/불량)
  - 날짜 정규화 (Excel 날짜 → ISO 8601)

#### 3.3 매입매출 파일 파싱 (2-3분)
- **파일**: 2025년 9월 매입매출 보고현황 (1).xlsx
- **변환 작업**:
  - 매입/매출 구분
  - 거래처 매칭
  - 금액 검증

### Phase 4: 마스터 데이터 임포트 (5-7분)

#### 4.1 거래처(companies) 임포트 (2-3분)
- **소스**: 태창금속 BOM.xlsx - 최신단가 시트
- **예상 레코드**: ~50개
- **검증**:
  - `company_code` 중복 체크
  - `company_type` 유효성 검증 (CUSTOMER/SUPPLIER/PARTNER/OTHER)
  - 필수 필드 확인 (company_name, company_code)

#### 4.2 품목(items) 임포트 (3-4분)
- **소스**: 모든 Excel 파일에서 품목 통합
- **예상 레코드**: ~450개
- **검증**:
  - `item_code` 중복 체크
  - `supplier_id` FK 검증 (companies 테이블)
  - `category` 유효성 검증
  - 완제품 vs 원자재 구분

### Phase 5: BOM 및 부가 데이터 임포트 (10-15분)

#### 5.1 BOM 관계 임포트 (5-7분)
- **소스**: 태창금속 BOM.xlsx (5개 고객사 시트)
- **예상 레코드**: 4,252개
- **검증**:
  - `parent_item_id`, `child_item_id` FK 검증
  - `level_no` 자동 계산 (1=완제품, 2=원자재)
  - 순환 참조 체크
  - `quantity_required` > 0 검증

#### 5.2 Coil 스펙 임포트 (2-3분)
- **소스**: 태창금속 BOM.xlsx - COIL 품목
- **예상 레코드**: ~100개
- **수식 계산**:
  ```
  weight_per_piece = (density × length × width × thickness) / 1,000,000 / sep_factor
  piece_unit_price = kg_unit_price × weight_per_piece
  ```
- **검증**:
  - `item_id` FK 검증
  - 모든 물리적 속성 > 0

#### 5.3 단가표(price_master) 임포트 (1-2분)
- **소스**: 태창금속 BOM.xlsx - 최신단가 시트
- **예상 레코드**: ~300개
- **검증**:
  - `item_id` FK 검증
  - `is_current = true`는 item당 1개만
  - `effective_date` 유효성

#### 5.4 스크랩 추적 임포트 (2-3분)
- **소스**: 태창금속 BOM.xlsx
- **예상 레코드**: ~200개
- **검증**:
  - `item_id` FK 검증
  - `scrap_weight` ≥ 0
  - `production_quantity` > 0

### Phase 6: 거래 데이터 임포트 (20-30분)

#### 6.1 재고 거래 임포트 (10-15분)
- **소스**: 종합관리 SHEET.xlsx (268개 일별 컬럼)
- **예상 레코드**: ~6,000개
- **변환 로직**:
  ```typescript
  for (const row of excelRows) {
    for (let day = 1; day <= 268; day++) {
      const quantity = row[`T${day}`]; // 일별 컬럼
      if (quantity && quantity !== 0) {
        transactions.push({
          item_id: findItemId(row.품목명),
          transaction_type: determineType(row, quantity),
          quantity: Math.abs(quantity),
          transaction_date: calculateDate(baseDate, day),
          warehouse_id: row.창고 || 'DEFAULT'
        });
      }
    }
  }
  ```
- **거래 유형 결정**:
  - `quantity > 0` → RECEIVING (입고)
  - `quantity < 0` + 생산실적 시트 → PRODUCTION (생산)
  - `quantity < 0` + 일반 → SHIPPING (출고)
  - 불량실적 → ADJUSTMENT (조정, 불량)

#### 6.2 매입 거래 임포트 (5-8분)
- **소스**: 매입매출 보고현황.xlsx, 매입 수불관리.xlsx
- **예상 레코드**: ~3,000개
- **검증**:
  - `supplier_id` FK 검증
  - `item_id` FK 검증
  - `total_amount` = `quantity × unit_price`
  - `payment_status` 자동 계산 (PENDING/PARTIAL/COMPLETED)

#### 6.3 매출 거래 임포트 (5-7분)
- **소스**: 매입매출 보고현황.xlsx
- **예상 레코드**: ~1,500개
- **검증**:
  - `customer_id` FK 검증
  - `item_id` FK 검증
  - `total_amount` 계산 검증
  - `payment_status` 자동 계산

### Phase 7: 데이터 검증 및 최적화 (8-15분)

#### 7.1 FK 관계 검증 (3-5분)
```sql
-- 고아 레코드 체크
SELECT 'items' AS table_name, COUNT(*) AS orphan_count
FROM items i
LEFT JOIN companies c ON i.supplier_id = c.company_id
WHERE i.supplier_id IS NOT NULL AND c.company_id IS NULL

UNION ALL

SELECT 'bom', COUNT(*)
FROM bom b
LEFT JOIN items parent ON b.parent_item_id = parent.item_id
LEFT JOIN items child ON b.child_item_id = child.item_id
WHERE parent.item_id IS NULL OR child.item_id IS NULL;
```

#### 7.2 재고 잔액 검증 (2-3분)
```sql
-- 재고 집계 vs items.current_stock 비교
SELECT
  i.item_id,
  i.item_name,
  i.current_stock AS recorded_stock,
  COALESCE(SUM(
    CASE
      WHEN it.transaction_type IN ('RECEIVING', 'PRODUCTION') THEN it.quantity
      WHEN it.transaction_type IN ('SHIPPING', 'ADJUSTMENT') THEN -it.quantity
    END
  ), 0) AS calculated_stock,
  i.current_stock - COALESCE(SUM(...), 0) AS difference
FROM items i
LEFT JOIN inventory_transactions it ON i.item_id = it.item_id
GROUP BY i.item_id
HAVING ABS(i.current_stock - COALESCE(SUM(...), 0)) > 0.01;
```

#### 7.3 금액 집계 검증 (2-3분)
```sql
-- Excel 원본 합계 vs 데이터베이스 합계 비교
SELECT
  '매입 총액' AS metric,
  SUM(total_amount) AS db_total
FROM purchase_transactions
WHERE transaction_date BETWEEN '2025-09-01' AND '2025-09-30';

SELECT
  '매출 총액' AS metric,
  SUM(total_amount) AS db_total
FROM sales_transactions
WHERE transaction_date BETWEEN '2025-09-01' AND '2025-09-30';
```

#### 7.4 인덱스 최적화 (1-2분)
- **자동 처리**: Supabase가 자동으로 통계 업데이트
- **수동 최적화** (필요 시):
  ```sql
  ANALYZE companies;
  ANALYZE items;
  ANALYZE bom;
  ANALYZE inventory_transactions;
  ```

#### 7.5 최종 레코드 수 확인 (1분)
```sql
SELECT
  'companies' AS table_name, COUNT(*) AS record_count FROM companies
UNION ALL
SELECT 'items', COUNT(*) FROM items
UNION ALL
SELECT 'bom', COUNT(*) FROM bom
UNION ALL
SELECT 'coil_specs', COUNT(*) FROM coil_specs
UNION ALL
SELECT 'price_master', COUNT(*) FROM price_master
UNION ALL
SELECT 'scrap_tracking', COUNT(*) FROM scrap_tracking
UNION ALL
SELECT 'inventory_transactions', COUNT(*) FROM inventory_transactions
UNION ALL
SELECT 'purchase_transactions', COUNT(*) FROM purchase_transactions
UNION ALL
SELECT 'sales_transactions', COUNT(*) FROM sales_transactions
ORDER BY table_name;
```

---

## 🛡️ 위험 관리

### 위험 요소

| 위험 | 확률 | 영향도 | 완화 전략 |
|------|-----|--------|----------|
| Excel 파일 손상 또는 읽기 실패 | 낮음 | 높음 | 사전 파일 검증, 백업 준비 |
| FK 제약조건 위반 | 중간 | 높음 | 단계별 검증, 롤백 계획 |
| 데이터 유실 | 낮음 | 매우 높음 | 백업 필수, 트랜잭션 사용 |
| 시계열 데이터 변환 오류 | 중간 | 중간 | 샘플 데이터 검증, 수동 확인 |
| 메모리 부족 (16.7MB 파일) | 낮음 | 중간 | 스트리밍 파싱, 배치 처리 |
| 중복 데이터 생성 | 중간 | 중간 | 유니크 제약조건, 중복 체크 |

### 롤백 계획

1. **Phase 1-2 실패 시**: 백업에서 복원
2. **Phase 3 실패 시**: Excel 파싱 재시도, 로그 확인
3. **Phase 4-6 실패 시**:
   - 부분 임포트된 데이터 삭제
   - 백업에서 복원
   - 오류 수정 후 재시도
4. **Phase 7 검증 실패 시**:
   - 오류 원인 파악
   - 데이터 수정 또는 재임포트

---

## ✅ 성공 기준

### 필수 기준 (Pass/Fail)

1. **데이터 무결성**:
   - [ ] 모든 FK 제약조건 만족
   - [ ] 필수 필드 NULL 없음
   - [ ] 중복 레코드 없음

2. **데이터 완전성**:
   - [ ] 예상 레코드 수 ±5% 이내
   - [ ] Excel 원본 집계값과 DB 집계값 차이 <1%

3. **기능 정상**:
   - [ ] 대시보드 정상 로딩
   - [ ] 모든 API 엔드포인트 정상 응답
   - [ ] BOM 조회 정상 작동

### 품질 기준 (권장)

1. **성능**:
   - [ ] 마이그레이션 완료 시간 < 2시간
   - [ ] API 응답 시간 < 500ms

2. **데이터 품질**:
   - [ ] 재고 잔액 정확도 99.9%
   - [ ] 금액 집계 정확도 99.9%

---

## 📝 체크리스트

### 사전 준비
- [ ] Supabase 프로젝트 접속 확인
- [ ] Excel 파일 4개 존재 확인
- [ ] Node.js 및 필요 패키지 설치
- [ ] 백업 저장 공간 확보 (최소 100MB)
- [ ] 마이그레이션 스크립트 준비

### 실행 중
- [ ] Phase 1: 백업 완료
- [ ] Phase 2: 테스트 데이터 삭제 완료
- [ ] Phase 3: Excel 파싱 완료
- [ ] Phase 4: 마스터 데이터 임포트 완료
- [ ] Phase 5: BOM 및 부가 데이터 임포트 완료
- [ ] Phase 6: 거래 데이터 임포트 완료
- [ ] Phase 7: 검증 및 최적화 완료

### 사후 검증
- [ ] 레코드 수 확인
- [ ] FK 관계 검증
- [ ] 재고 잔액 확인
- [ ] 금액 집계 확인
- [ ] 대시보드 테스트
- [ ] API 테스트

---

## 📅 실행 일정

**권장 실행 시간**: 업무 외 시간 (저녁 또는 주말)
**예상 소요시간**: 1시간 10분 ~ 1시간 40분
**완충 시간**: 30분 (문제 발생 시 대응)

**실행 전 확인사항**:
1. 현재 시스템 사용자 없음
2. 충분한 시간 확보
3. 네트워크 안정성 확인
4. Supabase 서비스 정상 상태 확인

---

## 📞 문제 발생 시 대응

1. **즉시 중단**: 마이그레이션 스크립트 중단 (Ctrl+C)
2. **로그 확인**: 에러 메시지 및 스택 트레이스 확인
3. **상태 점검**: 어느 단계까지 완료되었는지 확인
4. **롤백 실행**: 필요 시 백업에서 복원
5. **문제 해결**: 로그 분석 후 원인 파악 및 수정
6. **재시도**: 수정 후 해당 단계부터 재실행

---

## 📚 참고 문서

- [Excel 데이터 매핑 문서](./02_Excel_데이터_매핑.md)
- [데이터 검증 규칙](./03_데이터_검증_규칙.md)
- [마이그레이션 실행 매뉴얼](./04_마이그레이션_실행_매뉴얼.md)
- [문제 해결 가이드](./05_문제_해결_가이드.md)
