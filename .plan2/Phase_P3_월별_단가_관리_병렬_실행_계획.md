# Phase P3: ì›”ë³„ ë‹¨ê°€ ê´€ë¦¬ ë° ì¬ê³  ê¸ˆì•¡ ì¶”ì  ì‹œìŠ¤í…œ (ë³‘ë ¬ ì‹¤í–‰ ê³„íš)

## ğŸ“‹ ìš”êµ¬ì‚¬í•­ ë¶„ì„ (ëŒ€í™” ë‚´ìš© ê¸°ë°˜)

### í•µì‹¬ ìš”êµ¬ì‚¬í•­
1. **ì›”ë³„ ë‹¨ê°€ ë³€ë™ ì¶”ì **: ë¶€í’ˆ íŠ¹ì„±ìƒ ì›”ë§ˆë‹¤ ë‹¨ê°€ê°€ ë‹¤ë¦„ (ì˜ˆ: 10ì›” 1,000ì› â†’ 11ì›” 1,100ì›)
2. **ì¤‘ëŸ‰â†’ê¸ˆì•¡ í™˜ì‚°**: ë‹¨ê°€ë¥¼ ê³±í•˜ì—¬ ì¤‘ëŸ‰(kg)ì„ ê¸ˆì•¡(â‚©)ìœ¼ë¡œ ë³€í™˜
3. **ì¬ê³  ê¸ˆì•¡ ê³„ì‚°**: ì—…ì²´ë³„/í’ˆëª©ë³„/ì¹´í…Œê³ ë¦¬ë³„ ì¬ê³  ê¸ˆì•¡ ìë™ ê³„ì‚°
4. **ì›”ë³„ ì§‘ê³„**: ë§¤ì¶œ/ë§¤ì…/ìˆ˜ê¸ˆ/ì§€ê¸‰ + ì¬ê³  ê¸ˆì•¡ì˜ ì›”ë³„ ì¶”ì´ ë¶„ì„
5. **ì—‘ì…€ ëŒ€ì²´**: í˜„ì¬ Excel 10ê°œ ì‹œíŠ¸ + ë³µì¡í•œ ìˆ˜ì‹ì„ ì›¹ ERPë¡œ ì „í™˜

### í˜„ì¬ Excel ì›Œí¬í”Œë¡œìš° (ëŒ€ì²´ ëŒ€ìƒ)
- **ì •ë¦¬ ë³´ë“œ**: ì—…ì²´ë³„/êµ¬ë¶„ë³„ ê¸ˆì•¡ ì •ë¦¬ (ê³ ê°ì‚¬/í˜‘ë ¥ì‚¬/ì›ìì¬/ë¶€ìì¬/ì™„ì œí’ˆ)
- **ì›”ë³„ ì§‘ê³„**: 1ì¼~30ì¼ ë§¤ì¶œ/ë§¤ì…/ìˆ˜ê¸ˆ + ì¬ê³  í˜„í™©
- **ë‹¨ê°€ ê´€ë¦¬**: ì›”ë§ˆë‹¤ ë‹¨ê°€ ìˆ˜ì • ì‹œ í•´ë‹¹ ì›”ë¶€í„° ì ìš©
- **ì¬ê³  ê¸ˆì•¡**: í˜„ì¬ê³  Ã— ë‹¨ê°€ = ì¬ê³  ê¸ˆì•¡ (ì—…ì²´ë³„/í’ˆëª©ë³„)

## ğŸ¯ ëª©í‘œ

**MVP ê¸°ëŠ¥**: ì›”ë³„ ë‹¨ê°€ ê´€ë¦¬ + ì¬ê³  ê¸ˆì•¡ ìë™ ê³„ì‚° + ì›”ë³„ ì¬ë¬´ ëŒ€ì‹œë³´ë“œ

## ğŸ“Š 3-Wave ë³‘ë ¬ ì‹¤í–‰ ì „ëµ

### Wave 1: ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ + ë‹¨ê°€ ì´ë ¥ API (3-4ì¼)
- **ëª©ì **: ì›”ë³„ ë‹¨ê°€ ì´ë ¥ ì €ì¥ êµ¬ì¡° + CRUD API êµ¬ì¶•
- **ë³‘ë ¬ ì‘ì—…**: 5ê°œ íƒœìŠ¤í¬ ë™ì‹œ ì§„í–‰

### Wave 2: ì¬ê³  ê¸ˆì•¡ ê³„ì‚° ì—”ì§„ + ì›”ë³„ ì§‘ê³„ ë¡œì§ (4-5ì¼)
- **ëª©ì **: ì¬ê³  ê¸ˆì•¡ ìë™ ê³„ì‚° + ì¹´í…Œê³ ë¦¬ë³„ ì§‘ê³„ + Excel ëŒ€ì²´ ë¡œì§
- **ë³‘ë ¬ ì‘ì—…**: 3ê°œ íƒœìŠ¤í¬ ë™ì‹œ ì§„í–‰

### Wave 3: í”„ë¡ íŠ¸ì—”ë“œ ëŒ€ì‹œë³´ë“œ + ì—‘ì…€ Export (4-5ì¼)
- **ëª©ì **: ì›”ë³„ ë‹¨ê°€ ê´€ë¦¬ UI + ì¬ê³  ê¸ˆì•¡ ëŒ€ì‹œë³´ë“œ + ì •ë¦¬ ë³´ë“œ í™”ë©´
- **ë³‘ë ¬ ì‘ì—…**: 3ê°œ íƒœìŠ¤í¬ ë™ì‹œ ì§„í–‰

### Integration & Testing (1ì¼)
- **ëª©ì **: E2E í…ŒìŠ¤íŠ¸ + ê¸°ì¡´ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ + ì„±ëŠ¥ ê²€ì¦

**ì´ ì˜ˆìƒ ê¸°ê°„**: 12-15ì¼ (ë³‘ë ¬ ì‹¤í–‰ ê¸°ì¤€)

---

## ğŸ“‹ Wave 1: ë°ì´í„°ë² ì´ìŠ¤ + ë‹¨ê°€ ì´ë ¥ API (3-4ì¼)

### Task 1.1: ì›”ë³„ ë‹¨ê°€ ì´ë ¥ í…Œì´ë¸” ìƒì„± (supabase-schema-architect)
**ë‹´ë‹¹ ì—ì´ì „íŠ¸**: `supabase-schema-architect`
**ìš°ì„ ìˆœìœ„**: P0 (ì°¨ë‹¨ ì¡°ê±´)
**ì†Œìš” ì‹œê°„**: 6-8ì‹œê°„

#### ì‘ì—… ë‚´ìš©
1. `item_price_history` í…Œì´ë¸” ìƒì„± (ì›”ë³„ ë‹¨ê°€ ì´ë ¥)
2. `stock_valuation_monthly` ë·° ìƒì„± (ì›”ë³„ ì¬ê³  ê¸ˆì•¡ ì§‘ê³„)
3. ì¸ë±ìŠ¤ ìµœì í™” (ì›”ë³„ ì¡°íšŒ ì„±ëŠ¥)

#### ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜
```sql
-- supabase/migrations/20250116_create_item_price_history.sql

-- 1. ì›”ë³„ ë‹¨ê°€ ì´ë ¥ í…Œì´ë¸”
CREATE TABLE item_price_history (
  price_history_id SERIAL PRIMARY KEY,
  item_id INTEGER NOT NULL REFERENCES items(item_id) ON DELETE CASCADE,

  -- ì›”ë³„ ë‹¨ê°€ (ê¸°ì¤€ì¼: ë§¤ì›” 1ì¼)
  price_month DATE NOT NULL,  -- ì˜ˆ: 2025-10-01, 2025-11-01
  unit_price DECIMAL(15,2) NOT NULL CHECK (unit_price >= 0),

  -- ì¤‘ëŸ‰ ê¸°ë°˜ ë‹¨ê°€ (ì½”ì¼ ë“±)
  price_per_kg DECIMAL(15,2) DEFAULT NULL CHECK (price_per_kg >= 0 OR price_per_kg IS NULL),

  -- ë©”íƒ€ë°ì´í„°
  note TEXT,  -- ë‹¨ê°€ ë³€ê²½ ì‚¬ìœ 
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  created_by VARCHAR(100),

  -- ì›”ë³„ ë‹¨ê°€ëŠ” í•œ í’ˆëª©ë‹¹ í•œ ë‹¬ì— í•˜ë‚˜ì”©ë§Œ
  UNIQUE(item_id, price_month)
);

-- 2. ì¸ë±ìŠ¤: ì›”ë³„ ì¡°íšŒ ìµœì í™”
CREATE INDEX idx_price_history_month ON item_price_history(price_month DESC);
CREATE INDEX idx_price_history_item_month ON item_price_history(item_id, price_month DESC);

-- 3. íŠ¸ë¦¬ê±°: updated_at ìë™ ê°±ì‹ 
CREATE TRIGGER update_price_history_timestamp
  BEFORE UPDATE ON item_price_history
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- 4. PostgreSQL View: ì›”ë³„ ì¬ê³  ê¸ˆì•¡ ì§‘ê³„
CREATE OR REPLACE VIEW v_stock_valuation_monthly AS
SELECT
  DATE_TRUNC('month', CURRENT_DATE) AS valuation_month,
  i.item_id,
  i.item_code,
  i.item_name,
  i.category,
  i.current_stock,
  c.company_name AS supplier_name,
  c.company_category,

  -- ìµœì‹  ë‹¨ê°€ (í•´ë‹¹ ì›” or ê°€ì¥ ìµœê·¼ ê³¼ê±° ë‹¨ê°€)
  COALESCE(
    (SELECT unit_price
     FROM item_price_history iph
     WHERE iph.item_id = i.item_id
       AND iph.price_month <= DATE_TRUNC('month', CURRENT_DATE)
     ORDER BY iph.price_month DESC
     LIMIT 1),
    i.unit_price  -- ê¸°ë³¸ê°’: items í…Œì´ë¸”ì˜ unit_price
  ) AS current_unit_price,

  -- ì¬ê³  ê¸ˆì•¡ = í˜„ì¬ê³  Ã— ë‹¨ê°€
  i.current_stock * COALESCE(
    (SELECT unit_price
     FROM item_price_history iph
     WHERE iph.item_id = i.item_id
       AND iph.price_month <= DATE_TRUNC('month', CURRENT_DATE)
     ORDER BY iph.price_month DESC
     LIMIT 1),
    i.unit_price
  ) AS stock_value

FROM items i
LEFT JOIN companies c ON i.supplier_id = c.company_id
WHERE i.is_active = true AND i.current_stock > 0;

-- 5. ì¹´í…Œê³ ë¦¬ë³„ ì¬ê³  ê¸ˆì•¡ ì§‘ê³„ ë·°
CREATE OR REPLACE VIEW v_stock_value_by_category AS
SELECT
  DATE_TRUNC('month', CURRENT_DATE) AS valuation_month,

  -- ì¹´í…Œê³ ë¦¬ë³„ ì§‘ê³„
  CASE
    WHEN c.company_category = 'í˜‘ë ¥ì—…ì²´-ì›ìì¬' THEN 'ì›ìì¬'
    WHEN c.company_category = 'í˜‘ë ¥ì—…ì²´-ì™¸ì£¼' THEN 'ë¶€ìì¬'
    WHEN i.category LIKE '%ì™„ì œí’ˆ%' THEN 'ì™„ì œí’ˆ'
    WHEN i.category LIKE '%ë°˜ì œí’ˆ%' THEN 'ê³µì •ì¬ê³ '
    ELSE 'ê¸°íƒ€'
  END AS inventory_category,

  COUNT(DISTINCT i.item_id) AS item_count,
  SUM(i.current_stock) AS total_quantity,
  SUM(i.current_stock * COALESCE(
    (SELECT unit_price
     FROM item_price_history iph
     WHERE iph.item_id = i.item_id
       AND iph.price_month <= DATE_TRUNC('month', CURRENT_DATE)
     ORDER BY iph.price_month DESC
     LIMIT 1),
    i.unit_price
  )) AS total_value

FROM items i
LEFT JOIN companies c ON i.supplier_id = c.company_id
WHERE i.is_active = true AND i.current_stock > 0
GROUP BY inventory_category;

COMMENT ON TABLE item_price_history IS 'í’ˆëª©ë³„ ì›”ë³„ ë‹¨ê°€ ì´ë ¥ ì¶”ì ';
COMMENT ON VIEW v_stock_valuation_monthly IS 'ì›”ë³„ ì¬ê³  ê¸ˆì•¡ í‰ê°€ (í’ˆëª©ë³„)';
COMMENT ON VIEW v_stock_value_by_category IS 'ì¹´í…Œê³ ë¦¬ë³„ ì¬ê³  ê¸ˆì•¡ ì§‘ê³„ (ì›ìì¬/ë¶€ìì¬/ì™„ì œí’ˆ/ê³µì •ì¬ê³ )';
```

#### ê²€ì¦ ê¸°ì¤€
- [ ] í…Œì´ë¸” ìƒì„± ì„±ê³µ (item_price_history)
- [ ] ë·° 2ê°œ ìƒì„± ì„±ê³µ (v_stock_valuation_monthly, v_stock_value_by_category)
- [ ] ì¸ë±ìŠ¤ ìƒì„± í™•ì¸ (EXPLAIN ANALYZEë¡œ ì„±ëŠ¥ ê²€ì¦)
- [ ] ì œì•½ ì¡°ê±´ í…ŒìŠ¤íŠ¸ (UNIQUE, CHECK ì œì•½)

---

### Task 1.2: ë‹¨ê°€ ì´ë ¥ CRUD API êµ¬í˜„ (backend-architect)
**ë‹´ë‹¹ ì—ì´ì „íŠ¸**: `backend-architect`
**ìš°ì„ ìˆœìœ„**: P0
**ì†Œìš” ì‹œê°„**: 8-10ì‹œê°„

#### API ì—”ë“œí¬ì¸íŠ¸ (4ê°œ)

##### 1. GET /api/price-history/[itemId]
**ê¸°ëŠ¥**: íŠ¹ì • í’ˆëª©ì˜ ë‹¨ê°€ ì´ë ¥ ì¡°íšŒ (ì›”ë³„)

```typescript
// src/app/api/price-history/[itemId]/route.ts
import { NextRequest } from 'next/server';
import { getSupabaseClient } from '@/lib/db-unified';
import { createSuccessResponse, handleSupabaseError } from '@/lib/db-unified';

export async function GET(
  request: NextRequest,
  { params }: { params: { itemId: string } }
) {
  try {
    const { itemId } = params;
    const { searchParams } = new URL(request.url);
    const startMonth = searchParams.get('start_month'); // ì˜ˆ: 2025-01-01
    const endMonth = searchParams.get('end_month');     // ì˜ˆ: 2025-12-01

    const supabase = getSupabaseClient();
    let query = supabase
      .from('item_price_history')
      .select(`
        *,
        item:items!inner(item_code, item_name, spec, category)
      `)
      .eq('item_id', itemId)
      .order('price_month', { ascending: false });

    if (startMonth) {
      query = query.gte('price_month', startMonth);
    }
    if (endMonth) {
      query = query.lte('price_month', endMonth);
    }

    const { data, error } = await query;

    if (error) {
      return Response.json(
        handleSupabaseError('select', 'item_price_history', error),
        { status: 500 }
      );
    }

    return Response.json(
      createSuccessResponse({
        history: data,
        item_id: itemId,
        period: { start: startMonth, end: endMonth }
      })
    );
  } catch (error) {
    console.error('[API] price-history GET error:', error);
    return Response.json(
      { success: false, error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```

##### 2. GET /api/price-history/current
**ê¸°ëŠ¥**: í˜„ì¬ ì›” ê¸°ì¤€ ëª¨ë“  í’ˆëª©ì˜ ë‹¨ê°€ ì¡°íšŒ

```typescript
// src/app/api/price-history/current/route.ts
import { NextRequest } from 'next/server';
import { getSupabaseClient } from '@/lib/db-unified';
import { createSuccessResponse, handleSupabaseError } from '@/lib/db-unified';

export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url);
    const targetMonth = searchParams.get('month') ||
      new Date().toISOString().slice(0, 7) + '-01'; // ì˜ˆ: 2025-10-01

    const category = searchParams.get('category');
    const supplierId = searchParams.get('supplier_id');

    const supabase = getSupabaseClient();

    // í˜„ì¬ ì›” ë‹¨ê°€ ì¡°íšŒ (ì—†ìœ¼ë©´ ê°€ì¥ ìµœê·¼ ê³¼ê±° ë‹¨ê°€)
    const { data, error } = await supabase.rpc('get_current_item_prices', {
      p_target_month: targetMonth,
      p_category: category,
      p_supplier_id: supplierId ? parseInt(supplierId) : null
    });

    if (error) {
      return Response.json(
        handleSupabaseError('rpc', 'get_current_item_prices', error),
        { status: 500 }
      );
    }

    return Response.json(
      createSuccessResponse({
        items: data,
        target_month: targetMonth,
        total_items: data?.length || 0
      })
    );
  } catch (error) {
    console.error('[API] current prices GET error:', error);
    return Response.json(
      { success: false, error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```

##### 3. POST /api/price-history
**ê¸°ëŠ¥**: ì›”ë³„ ë‹¨ê°€ ë“±ë¡ (ë‹¨ì¼ or ëŒ€ëŸ‰)

```typescript
// src/app/api/price-history/route.ts
import { NextRequest } from 'next/server';
import { getSupabaseClient } from '@/lib/db-unified';
import { createSuccessResponse, handleSupabaseError } from '@/lib/db-unified';

interface PriceHistoryInput {
  item_id: number;
  price_month: string;  // YYYY-MM-01 í˜•ì‹
  unit_price: number;
  price_per_kg?: number;
  note?: string;
  created_by?: string;
}

export async function POST(request: NextRequest) {
  try {
    // âœ… CRITICAL: í•œê¸€ ì¸ì½”ë”© íŒ¨í„´ (ëª¨ë“  POST API í•„ìˆ˜!)
    const text = await request.text();
    const body = JSON.parse(text);

    const supabase = getSupabaseClient();

    // ë‹¨ì¼ ë“±ë¡ vs ëŒ€ëŸ‰ ë“±ë¡
    const isArray = Array.isArray(body.prices);
    const prices: PriceHistoryInput[] = isArray ? body.prices : [body];

    // ëŒ€ëŸ‰ ë“±ë¡: UPSERT ì‚¬ìš© (ì¶©ëŒ ì‹œ UPDATE)
    const { data, error } = await supabase
      .from('item_price_history')
      .upsert(
        prices.map(p => ({
          ...p,
          updated_at: new Date().toISOString()
        })),
        {
          onConflict: 'item_id,price_month',
          ignoreDuplicates: false  // ì¤‘ë³µ ì‹œ UPDATE
        }
      )
      .select();

    if (error) {
      return Response.json(
        handleSupabaseError('upsert', 'item_price_history', error),
        { status: 500 }
      );
    }

    return Response.json(
      createSuccessResponse({
        prices: data,
        count: data?.length || 0,
        message: `${data?.length || 0}ê°œ í’ˆëª© ë‹¨ê°€ ${isArray ? 'ëŒ€ëŸ‰ ' : ''}ë“±ë¡ ì™„ë£Œ`
      }),
      { status: 201 }
    );
  } catch (error) {
    console.error('[API] price-history POST error:', error);
    return Response.json(
      { success: false, error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```

##### 4. PUT /api/price-history/[priceHistoryId]
**ê¸°ëŠ¥**: ë‹¨ê°€ ì´ë ¥ ìˆ˜ì •

```typescript
// src/app/api/price-history/[priceHistoryId]/route.ts
import { NextRequest } from 'next/server';
import { getSupabaseClient } from '@/lib/db-unified';
import { createSuccessResponse, handleSupabaseError } from '@/lib/db-unified';

export async function PUT(
  request: NextRequest,
  { params }: { params: { priceHistoryId: string } }
) {
  try {
    const { priceHistoryId } = params;

    // âœ… í•œê¸€ ì¸ì½”ë”© íŒ¨í„´
    const text = await request.text();
    const body = JSON.parse(text);

    const supabase = getSupabaseClient();
    const { data, error } = await supabase
      .from('item_price_history')
      .update({
        ...body,
        updated_at: new Date().toISOString()
      })
      .eq('price_history_id', priceHistoryId)
      .select()
      .single();

    if (error) {
      return Response.json(
        handleSupabaseError('update', 'item_price_history', error),
        { status: 500 }
      );
    }

    return Response.json(createSuccessResponse(data));
  } catch (error) {
    console.error('[API] price-history PUT error:', error);
    return Response.json(
      { success: false, error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```

#### PostgreSQL í•¨ìˆ˜: get_current_item_prices
```sql
-- supabase/migrations/20250116_create_price_functions.sql
CREATE OR REPLACE FUNCTION get_current_item_prices(
  p_target_month DATE,
  p_category TEXT DEFAULT NULL,
  p_supplier_id INTEGER DEFAULT NULL
)
RETURNS TABLE (
  item_id INTEGER,
  item_code VARCHAR,
  item_name VARCHAR,
  spec VARCHAR,
  category VARCHAR,
  current_stock INTEGER,
  supplier_name VARCHAR,
  unit_price DECIMAL(15,2),
  price_month DATE,
  is_historical BOOLEAN  -- trueë©´ ê³¼ê±° ë‹¨ê°€, falseë©´ í˜„ì¬ ì›” ë‹¨ê°€
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    i.item_id,
    i.item_code,
    i.item_name,
    i.spec,
    i.category,
    i.current_stock,
    c.company_name AS supplier_name,

    -- í˜„ì¬ ì›” ë‹¨ê°€ or ê°€ì¥ ìµœê·¼ ê³¼ê±° ë‹¨ê°€
    COALESCE(
      (SELECT iph.unit_price
       FROM item_price_history iph
       WHERE iph.item_id = i.item_id
         AND iph.price_month <= p_target_month
       ORDER BY iph.price_month DESC
       LIMIT 1),
      i.unit_price  -- ê¸°ë³¸ê°’
    ) AS unit_price,

    COALESCE(
      (SELECT iph.price_month
       FROM item_price_history iph
       WHERE iph.item_id = i.item_id
         AND iph.price_month <= p_target_month
       ORDER BY iph.price_month DESC
       LIMIT 1),
      NULL
    ) AS price_month,

    -- ê³¼ê±° ë‹¨ê°€ì¸ì§€ ì—¬ë¶€
    COALESCE(
      (SELECT iph.price_month < p_target_month
       FROM item_price_history iph
       WHERE iph.item_id = i.item_id
         AND iph.price_month <= p_target_month
       ORDER BY iph.price_month DESC
       LIMIT 1),
      false
    ) AS is_historical

  FROM items i
  LEFT JOIN companies c ON i.supplier_id = c.company_id
  WHERE i.is_active = true
    AND (p_category IS NULL OR i.category = p_category)
    AND (p_supplier_id IS NULL OR i.supplier_id = p_supplier_id)
  ORDER BY i.item_code;
END;
$$ LANGUAGE plpgsql;

COMMENT ON FUNCTION get_current_item_prices IS 'ì§€ì • ì›” ê¸°ì¤€ í’ˆëª©ë³„ í˜„ì¬ ë‹¨ê°€ ì¡°íšŒ (ì—†ìœ¼ë©´ ê°€ì¥ ìµœê·¼ ê³¼ê±° ë‹¨ê°€)';
```

#### ê²€ì¦ ê¸°ì¤€
- [ ] 4ê°œ API ì—”ë“œí¬ì¸íŠ¸ ë™ì‘ í™•ì¸
- [ ] ëŒ€ëŸ‰ ë‹¨ê°€ ë“±ë¡ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ (100ê°œ í’ˆëª© < 2ì´ˆ)
- [ ] UPSERT ì¶©ëŒ ì²˜ë¦¬ ê²€ì¦ (ê°™ì€ ì›” ì¤‘ë³µ ë“±ë¡ ì‹œ UPDATE)
- [ ] í•œê¸€ ì¸ì½”ë”© ê²€ì¦ (note í•„ë“œì— í•œê¸€ ì…ë ¥ í…ŒìŠ¤íŠ¸)
- [ ] PostgreSQL í•¨ìˆ˜ get_current_item_prices ë™ì‘ í™•ì¸

---

### Task 1.3: ì¬ê³  ê¸ˆì•¡ ì¡°íšŒ API êµ¬í˜„ (backend-architect)
**ë‹´ë‹¹ ì—ì´ì „íŠ¸**: `backend-architect`
**ìš°ì„ ìˆœìœ„**: P1
**ì†Œìš” ì‹œê°„**: 6-8ì‹œê°„

#### API ì—”ë“œí¬ì¸íŠ¸ (3ê°œ)

##### 1. GET /api/stock/valuation
**ê¸°ëŠ¥**: í’ˆëª©ë³„ ì¬ê³  ê¸ˆì•¡ ì¡°íšŒ

```typescript
// src/app/api/stock/valuation/route.ts
import { NextRequest } from 'next/server';
import { getSupabaseClient } from '@/lib/db-unified';
import { createSuccessResponse, handleSupabaseError } from '@/lib/db-unified';

export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url);
    const month = searchParams.get('month') ||
      new Date().toISOString().slice(0, 7) + '-01';
    const category = searchParams.get('category');
    const supplierId = searchParams.get('supplier_id');

    const supabase = getSupabaseClient();

    // v_stock_valuation_monthly ë·° ì¡°íšŒ
    let query = supabase
      .from('v_stock_valuation_monthly')
      .select('*')
      .order('stock_value', { ascending: false });

    if (category) {
      query = query.eq('category', category);
    }
    if (supplierId) {
      query = query.eq('supplier_id', parseInt(supplierId));
    }

    const { data, error } = await query;

    if (error) {
      return Response.json(
        handleSupabaseError('select', 'v_stock_valuation_monthly', error),
        { status: 500 }
      );
    }

    // ì§‘ê³„ í†µê³„
    const totalValue = data?.reduce((sum, item) => sum + parseFloat(item.stock_value || '0'), 0) || 0;
    const totalItems = data?.length || 0;
    const avgValue = totalItems > 0 ? totalValue / totalItems : 0;

    return Response.json(
      createSuccessResponse({
        items: data,
        summary: {
          total_items: totalItems,
          total_stock_value: totalValue,
          avg_stock_value: avgValue,
          valuation_month: month
        }
      })
    );
  } catch (error) {
    console.error('[API] stock valuation GET error:', error);
    return Response.json(
      { success: false, error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```

##### 2. GET /api/stock/valuation/category
**ê¸°ëŠ¥**: ì¹´í…Œê³ ë¦¬ë³„ ì¬ê³  ê¸ˆì•¡ ì§‘ê³„

```typescript
// src/app/api/stock/valuation/category/route.ts
import { NextRequest } from 'next/server';
import { getSupabaseClient } from '@/lib/db-unified';
import { createSuccessResponse, handleSupabaseError } from '@/lib/db-unified';

export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url);
    const month = searchParams.get('month') ||
      new Date().toISOString().slice(0, 7) + '-01';

    const supabase = getSupabaseClient();

    // v_stock_value_by_category ë·° ì¡°íšŒ
    const { data, error } = await supabase
      .from('v_stock_value_by_category')
      .select('*')
      .order('total_value', { ascending: false });

    if (error) {
      return Response.json(
        handleSupabaseError('select', 'v_stock_value_by_category', error),
        { status: 500 }
      );
    }

    // ì´í•© ê³„ì‚°
    const totalValue = data?.reduce((sum, cat) => sum + parseFloat(cat.total_value || '0'), 0) || 0;

    return Response.json(
      createSuccessResponse({
        categories: data,
        summary: {
          total_value: totalValue,
          valuation_month: month,
          category_count: data?.length || 0
        }
      })
    );
  } catch (error) {
    console.error('[API] stock valuation category GET error:', error);
    return Response.json(
      { success: false, error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```

##### 3. GET /api/stock/valuation/supplier
**ê¸°ëŠ¥**: ì—…ì²´ë³„ ì¬ê³  ê¸ˆì•¡ ì§‘ê³„

```typescript
// src/app/api/stock/valuation/supplier/route.ts
import { NextRequest } from 'next/server';
import { getSupabaseClient } from '@/lib/db-unified';
import { createSuccessResponse, handleSupabaseError } from '@/lib/db-unified';

export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url);
    const month = searchParams.get('month') ||
      new Date().toISOString().slice(0, 7) + '-01';

    const supabase = getSupabaseClient();

    // ì—…ì²´ë³„ ì¬ê³  ê¸ˆì•¡ ì§‘ê³„ (v_stock_valuation_monthly ê¸°ë°˜)
    const { data, error } = await supabase
      .from('v_stock_valuation_monthly')
      .select('supplier_name, company_category, stock_value')
      .order('supplier_name');

    if (error) {
      return Response.json(
        handleSupabaseError('select', 'v_stock_valuation_monthly', error),
        { status: 500 }
      );
    }

    // ì—…ì²´ë³„ ì§‘ê³„
    const supplierMap = new Map<string, {
      supplier_name: string;
      company_category: string;
      total_value: number;
      item_count: number;
    }>();

    data?.forEach(item => {
      const key = item.supplier_name || 'Unknown';
      if (!supplierMap.has(key)) {
        supplierMap.set(key, {
          supplier_name: key,
          company_category: item.company_category || '',
          total_value: 0,
          item_count: 0
        });
      }
      const supplier = supplierMap.get(key)!;
      supplier.total_value += parseFloat(item.stock_value || '0');
      supplier.item_count += 1;
    });

    const suppliers = Array.from(supplierMap.values())
      .sort((a, b) => b.total_value - a.total_value);

    const totalValue = suppliers.reduce((sum, s) => sum + s.total_value, 0);

    return Response.json(
      createSuccessResponse({
        suppliers,
        summary: {
          total_value: totalValue,
          supplier_count: suppliers.length,
          valuation_month: month
        }
      })
    );
  } catch (error) {
    console.error('[API] stock valuation supplier GET error:', error);
    return Response.json(
      { success: false, error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```

#### ê²€ì¦ ê¸°ì¤€
- [ ] 3ê°œ API ì—”ë“œí¬ì¸íŠ¸ ë™ì‘ í™•ì¸
- [ ] ì¬ê³  ê¸ˆì•¡ ê³„ì‚° ì •í™•ë„ ê²€ì¦ (ìˆ˜ë™ ê³„ì‚°ê³¼ ë¹„êµ)
- [ ] ì¹´í…Œê³ ë¦¬ë³„ ì§‘ê³„ ê²€ì¦ (ì›ìì¬/ë¶€ìì¬/ì™„ì œí’ˆ/ê³µì •ì¬ê³ )
- [ ] ì—…ì²´ë³„ ì§‘ê³„ ê²€ì¦ (supplier_name ê¸°ì¤€)
- [ ] ì‘ë‹µ ì‹œê°„ < 500ms (1000ê°œ í’ˆëª© ê¸°ì¤€)

---

### Task 1.4: ì›”ë³„ ì¬ë¬´ ì§‘ê³„ API êµ¬í˜„ (backend-architect)
**ë‹´ë‹¹ ì—ì´ì „íŠ¸**: `backend-architect`
**ìš°ì„ ìˆœìœ„**: P1
**ì†Œìš” ì‹œê°„**: 6-8ì‹œê°„

#### API ì—”ë“œí¬ì¸íŠ¸ (1ê°œ)

##### GET /api/financial/monthly-summary
**ê¸°ëŠ¥**: ì›”ë³„ ë§¤ì¶œ/ë§¤ì…/ìˆ˜ê¸ˆ/ì§€ê¸‰ + ì¬ê³  ê¸ˆì•¡ í†µí•© ì¡°íšŒ (ì •ë¦¬ ë³´ë“œ ëŒ€ì²´)

```typescript
// src/app/api/financial/monthly-summary/route.ts
import { NextRequest } from 'next/server';
import { getSupabaseClient } from '@/lib/db-unified';
import { createSuccessResponse, handleSupabaseError } from '@/lib/db-unified';

export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url);
    const year = searchParams.get('year') || new Date().getFullYear().toString();
    const month = searchParams.get('month') || (new Date().getMonth() + 1).toString();

    const startDate = `${year}-${month.padStart(2, '0')}-01`;
    const endDate = new Date(parseInt(year), parseInt(month), 0)
      .toISOString().slice(0, 10);  // ë§ˆì§€ë§‰ ë‚ 

    const supabase = getSupabaseClient();

    // 1. ë§¤ì¶œ ì§‘ê³„ (sales_transactions)
    const { data: salesData } = await supabase
      .from('sales_transactions')
      .select('transaction_date, total_amount, customer_id, customer:companies!customer_id(company_name, company_category)')
      .gte('transaction_date', startDate)
      .lte('transaction_date', endDate);

    // 2. ë§¤ì… ì§‘ê³„ (purchase_transactions)
    const { data: purchaseData } = await supabase
      .from('purchase_transactions')
      .select('transaction_date, total_amount, supplier_id, supplier:companies!supplier_id(company_name, company_category)')
      .gte('transaction_date', startDate)
      .lte('transaction_date', endDate);

    // 3. ìˆ˜ê¸ˆ ì§‘ê³„ (collections)
    const { data: collectionsData } = await supabase
      .from('collections')
      .select('collection_date, amount, customer_id, customer:companies!customer_id(company_name)')
      .gte('collection_date', startDate)
      .lte('collection_date', endDate);

    // 4. ì§€ê¸‰ ì§‘ê³„ (payments)
    const { data: paymentsData } = await supabase
      .from('payments')
      .select('payment_date, amount, supplier_id, supplier:companies!supplier_id(company_name)')
      .gte('payment_date', startDate)
      .lte('payment_date', endDate);

    // 5. ì¬ê³  ê¸ˆì•¡ (v_stock_valuation_monthly)
    const { data: stockData } = await supabase
      .from('v_stock_valuation_monthly')
      .select('*');

    // 6. ì¼ë³„ ì§‘ê³„ (1ì¼~30ì¼)
    const dailySummary = generateDailySummary(
      salesData || [],
      purchaseData || [],
      collectionsData || [],
      paymentsData || [],
      stockData || [],
      year,
      month
    );

    // 7. ì›”ë³„ ì´ê³„
    const totalSales = salesData?.reduce((sum, s) => sum + parseFloat(s.total_amount || '0'), 0) || 0;
    const totalPurchases = purchaseData?.reduce((sum, p) => sum + parseFloat(p.total_amount || '0'), 0) || 0;
    const totalCollections = collectionsData?.reduce((sum, c) => sum + parseFloat(c.amount || '0'), 0) || 0;
    const totalPayments = paymentsData?.reduce((sum, p) => sum + parseFloat(p.amount || '0'), 0) || 0;
    const totalStockValue = stockData?.reduce((sum, s) => sum + parseFloat(s.stock_value || '0'), 0) || 0;

    // 8. ì—…ì²´ë³„ ì§‘ê³„ (ê³ ê°ì‚¬/í˜‘ë ¥ì‚¬)
    const customerSummary = aggregateByCompany(salesData || [], collectionsData || []);
    const supplierSummary = aggregateByCompany(purchaseData || [], paymentsData || []);

    return Response.json(
      createSuccessResponse({
        period: { year, month, start_date: startDate, end_date: endDate },
        daily_summary: dailySummary,
        monthly_total: {
          sales: totalSales,
          purchases: totalPurchases,
          collections: totalCollections,
          payments: totalPayments,
          stock_value: totalStockValue,
          net_cash_flow: totalCollections - totalPayments
        },
        customers: customerSummary,
        suppliers: supplierSummary
      })
    );
  } catch (error) {
    console.error('[API] financial monthly-summary GET error:', error);
    return Response.json(
      { success: false, error: 'Internal server error' },
      { status: 500 }
    );
  }
}

// Helper: ì¼ë³„ ì§‘ê³„ ìƒì„± (1ì¼~30ì¼)
function generateDailySummary(
  sales: any[],
  purchases: any[],
  collections: any[],
  payments: any[],
  stock: any[],
  year: string,
  month: string
) {
  const daysInMonth = new Date(parseInt(year), parseInt(month), 0).getDate();
  const daily = [];

  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = `${year}-${month.padStart(2, '0')}-${day.toString().padStart(2, '0')}`;

    const daySales = sales.filter(s => s.transaction_date === dateStr)
      .reduce((sum, s) => sum + parseFloat(s.total_amount || '0'), 0);

    const dayPurchases = purchases.filter(p => p.transaction_date === dateStr)
      .reduce((sum, p) => sum + parseFloat(p.total_amount || '0'), 0);

    const dayCollections = collections.filter(c => c.collection_date === dateStr)
      .reduce((sum, c) => sum + parseFloat(c.amount || '0'), 0);

    const dayPayments = payments.filter(p => p.payment_date === dateStr)
      .reduce((sum, p) => sum + parseFloat(p.amount || '0'), 0);

    daily.push({
      date: dateStr,
      day,
      sales: daySales,
      purchases: dayPurchases,
      collections: dayCollections,
      payments: dayPayments,
      net_cash_flow: dayCollections - dayPayments
    });
  }

  return daily;
}

// Helper: ì—…ì²´ë³„ ì§‘ê³„
function aggregateByCompany(transactions: any[], payments: any[]) {
  const companyMap = new Map<string, {
    company_name: string;
    company_category: string;
    total_amount: number;
    paid_amount: number;
    outstanding: number;
    transaction_count: number;
  }>();

  transactions.forEach(t => {
    const company = t.customer || t.supplier;
    if (!company) return;

    const key = company.company_name;
    if (!companyMap.has(key)) {
      companyMap.set(key, {
        company_name: key,
        company_category: company.company_category || '',
        total_amount: 0,
        paid_amount: 0,
        outstanding: 0,
        transaction_count: 0
      });
    }
    const entry = companyMap.get(key)!;
    entry.total_amount += parseFloat(t.total_amount || '0');
    entry.transaction_count += 1;
  });

  payments.forEach(p => {
    const company = p.customer || p.supplier;
    if (!company) return;

    const key = company.company_name;
    if (companyMap.has(key)) {
      const entry = companyMap.get(key)!;
      entry.paid_amount += parseFloat(p.amount || '0');
    }
  });

  // ë¯¸ìˆ˜ê¸ˆ/ë¯¸ì§€ê¸‰ê¸ˆ ê³„ì‚°
  companyMap.forEach((entry) => {
    entry.outstanding = entry.total_amount - entry.paid_amount;
  });

  return Array.from(companyMap.values())
    .sort((a, b) => b.total_amount - a.total_amount);
}
```

#### ê²€ì¦ ê¸°ì¤€
- [ ] API ì—”ë“œí¬ì¸íŠ¸ ë™ì‘ í™•ì¸
- [ ] ì¼ë³„ ì§‘ê³„ ì •í™•ë„ ê²€ì¦ (1ì¼~30ì¼)
- [ ] ì—…ì²´ë³„ ì§‘ê³„ ì •í™•ë„ ê²€ì¦ (ê³ ê°ì‚¬/í˜‘ë ¥ì‚¬)
- [ ] ì‘ë‹µ ì‹œê°„ < 1ì´ˆ (1000ê°œ ê±°ë˜ ê¸°ì¤€)
- [ ] Excel ì •ë¦¬ ë³´ë“œì™€ ë¹„êµ ê²€ì¦

---

### Task 1.5: Excel ë‹¨ê°€ Import/Export ê¸°ëŠ¥ (erp-specialist)
**ë‹´ë‹¹ ì—ì´ì „íŠ¸**: `erp-specialist`
**ìš°ì„ ìˆœìœ„**: P2
**ì†Œìš” ì‹œê°„**: 4-6ì‹œê°„

#### Excel í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ API
```typescript
// src/app/api/download/template/price-history/route.ts
import * as XLSX from 'xlsx';
import { getSupabaseClient } from '@/lib/db-unified';

export async function GET() {
  try {
    const supabase = getSupabaseClient();

    // í˜„ì¬ í’ˆëª© ëª©ë¡ ì¡°íšŒ
    const { data: items } = await supabase
      .from('items')
      .select('item_id, item_code, item_name, spec, category, unit_price')
      .eq('is_active', true)
      .order('item_code');

    const workbook = XLSX.utils.book_new();

    // Sheet 1: í…œí”Œë¦¿ ì„¤ëª…
    const infoSheet = XLSX.utils.aoa_to_sheet([
      ['ì›”ë³„ ë‹¨ê°€ Import í…œí”Œë¦¿', ''],
      ['ì‘ì„±ì¼', new Date().toLocaleDateString('ko-KR')],
      ['ì‘ì„± ë°©ë²•', ''],
      ['1. ê¸°ì¤€ì›” ì…ë ¥ (ì˜ˆ: 2025-10-01)', ''],
      ['2. í’ˆëª©ë³„ ë‹¨ê°€ ì…ë ¥', ''],
      ['3. íŒŒì¼ ì—…ë¡œë“œ', '']
    ]);

    // Sheet 2: í’ˆëª© ëª©ë¡ (ë‹¨ê°€ ì…ë ¥ìš©)
    const priceData = items?.map(item => ({
      'í’ˆëª©ì½”ë“œ': item.item_code,
      'í’ˆëª©ëª…': item.item_name,
      'ê·œê²©': item.spec || '',
      'ë¶„ë¥˜': item.category || '',
      'í˜„ì¬ë‹¨ê°€': item.unit_price,
      'ê¸°ì¤€ì›”': '',  // ì‚¬ìš©ì ì…ë ¥ í•„ìš”
      'ì‹ ê·œë‹¨ê°€': '',  // ì‚¬ìš©ì ì…ë ¥ í•„ìš”
      'kgë‹¹ë‹¨ê°€': '',  // ì˜µì…˜
      'ë¹„ê³ ': ''
    })) || [];

    const dataSheet = XLSX.utils.json_to_sheet(priceData);

    XLSX.utils.book_append_sheet(workbook, infoSheet, 'í…œí”Œë¦¿ ì•ˆë‚´');
    XLSX.utils.book_append_sheet(workbook, dataSheet, 'í’ˆëª©ë‹¨ê°€');

    const buffer = XLSX.write(workbook, { type: 'buffer', bookType: 'xlsx' });

    return new Response(buffer, {
      headers: {
        'Content-Type': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'Content-Disposition': `attachment; filename="ì›”ë³„ë‹¨ê°€í…œí”Œë¦¿_${new Date().toISOString().slice(0, 10)}.xlsx"`
      }
    });
  } catch (error) {
    console.error('[API] price template download error:', error);
    return Response.json(
      { success: false, error: 'Template generation failed' },
      { status: 500 }
    );
  }
}
```

#### Excel ë‹¨ê°€ Import API
```typescript
// src/app/api/upload/price-history/route.ts
import { NextRequest } from 'next/server';
import * as XLSX from 'xlsx';
import { getSupabaseClient } from '@/lib/db-unified';
import { createSuccessResponse } from '@/lib/db-unified';

export async function POST(request: NextRequest) {
  try {
    const formData = await request.formData();
    const file = formData.get('file') as File;

    if (!file) {
      return Response.json(
        { success: false, error: 'No file provided' },
        { status: 400 }
      );
    }

    const buffer = Buffer.from(await file.arrayBuffer());
    const workbook = XLSX.read(buffer, { type: 'buffer' });

    // 'í’ˆëª©ë‹¨ê°€' ì‹œíŠ¸ ì½ê¸°
    const sheetName = 'í’ˆëª©ë‹¨ê°€';
    const worksheet = workbook.Sheets[sheetName];

    if (!worksheet) {
      return Response.json(
        { success: false, error: `ì‹œíŠ¸ "${sheetName}"ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤` },
        { status: 400 }
      );
    }

    const rows = XLSX.utils.sheet_to_json<{
      í’ˆëª©ì½”ë“œ: string;
      ê¸°ì¤€ì›”: string;
      ì‹ ê·œë‹¨ê°€: number;
      kgë‹¹ë‹¨ê°€?: number;
      ë¹„ê³ ?: string;
    }>(worksheet);

    // ê²€ì¦ ë° ë³€í™˜
    const supabase = getSupabaseClient();
    const prices: any[] = [];
    const errors: string[] = [];

    for (const [index, row] of rows.entries()) {
      const rowNum = index + 2;  // Excel í–‰ ë²ˆí˜¸ (í—¤ë” ì œì™¸)

      // í•„ìˆ˜ í•„ë“œ ê²€ì¦
      if (!row.í’ˆëª©ì½”ë“œ || !row.ê¸°ì¤€ì›” || !row.ì‹ ê·œë‹¨ê°€) {
        errors.push(`í–‰ ${rowNum}: í’ˆëª©ì½”ë“œ, ê¸°ì¤€ì›”, ì‹ ê·œë‹¨ê°€ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤`);
        continue;
      }

      // í’ˆëª© ì¡´ì¬ í™•ì¸
      const { data: item } = await supabase
        .from('items')
        .select('item_id')
        .eq('item_code', row.í’ˆëª©ì½”ë“œ)
        .eq('is_active', true)
        .single();

      if (!item) {
        errors.push(`í–‰ ${rowNum}: í’ˆëª©ì½”ë“œ "${row.í’ˆëª©ì½”ë“œ}"ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤`);
        continue;
      }

      // ê¸°ì¤€ì›” í˜•ì‹ ê²€ì¦ (YYYY-MM-01)
      const priceMonth = row.ê¸°ì¤€ì›”.toString();
      if (!/^\d{4}-\d{2}-01$/.test(priceMonth)) {
        errors.push(`í–‰ ${rowNum}: ê¸°ì¤€ì›” í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤ (ì˜ˆ: 2025-10-01)`);
        continue;
      }

      prices.push({
        item_id: item.item_id,
        price_month: priceMonth,
        unit_price: parseFloat(row.ì‹ ê·œë‹¨ê°€.toString()),
        price_per_kg: row.kgë‹¹ë‹¨ê°€ ? parseFloat(row.kgë‹¹ë‹¨ê°€.toString()) : null,
        note: row.ë¹„ê³  || null,
        created_by: 'Excel Import'
      });
    }

    if (errors.length > 0 && prices.length === 0) {
      return Response.json(
        { success: false, error: 'ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', validation_errors: errors },
        { status: 400 }
      );
    }

    // ëŒ€ëŸ‰ UPSERT
    const { data, error } = await supabase
      .from('item_price_history')
      .upsert(prices, {
        onConflict: 'item_id,price_month',
        ignoreDuplicates: false
      })
      .select();

    if (error) {
      return Response.json(
        { success: false, error: error.message },
        { status: 500 }
      );
    }

    return Response.json(
      createSuccessResponse({
        imported_count: data?.length || 0,
        validation_errors: errors.length > 0 ? errors : undefined,
        message: `${data?.length || 0}ê°œ í’ˆëª© ë‹¨ê°€ ë“±ë¡ ì™„ë£Œ${errors.length > 0 ? ` (${errors.length}ê°œ ì˜¤ë¥˜)` : ''}`
      }),
      { status: 201 }
    );
  } catch (error) {
    console.error('[API] price-history upload error:', error);
    return Response.json(
      { success: false, error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```

#### ê²€ì¦ ê¸°ì¤€
- [ ] Excel í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ ë™ì‘ í™•ì¸
- [ ] Excel Import ì„±ê³µ (100ê°œ í’ˆëª© < 3ì´ˆ)
- [ ] ê²€ì¦ ì˜¤ë¥˜ í•¸ë“¤ë§ (í’ˆëª©ì½”ë“œ ì—†ìŒ, ë‚ ì§œ í˜•ì‹ ì˜¤ë¥˜)
- [ ] UPSERT ë™ì‘ í™•ì¸ (ì¤‘ë³µ ì›” ë‹¨ê°€ UPDATE)
- [ ] í•œê¸€ í’ˆëª©ëª…/ë¹„ê³  ì¸ì½”ë”© í™•ì¸

---

## ğŸ“‹ Wave 2: ì¬ê³  ê¸ˆì•¡ ê³„ì‚° ì—”ì§„ + ì›”ë³„ ì§‘ê³„ (4-5ì¼)

### Task 2.1: ì¬ê³  ê¸ˆì•¡ ê³„ì‚° ë¡œì§ ë¼ì´ë¸ŒëŸ¬ë¦¬ (backend-architect)
**ë‹´ë‹¹ ì—ì´ì „íŠ¸**: `backend-architect`
**ìš°ì„ ìˆœìœ„**: P0
**ì†Œìš” ì‹œê°„**: 8-10ì‹œê°„

#### ì¬ê³  ê¸ˆì•¡ ê³„ì‚° í´ë˜ìŠ¤
```typescript
// src/lib/stock-value-calculator.ts
import { SupabaseClient } from '@supabase/supabase-js';
import { Database } from '@/types/supabase';

interface StockValuationResult {
  item_id: number;
  item_code: string;
  item_name: string;
  current_stock: number;
  unit_price: number;
  stock_value: number;
  price_month: string;
  is_historical_price: boolean;
}

interface CategoryValuationResult {
  inventory_category: string;
  item_count: number;
  total_quantity: number;
  total_value: number;
}

export class StockValueCalculator {
  private supabase: SupabaseClient<Database>;
  private valuationCache: Map<string, StockValuationResult[]> = new Map();

  constructor(supabase: SupabaseClient<Database>) {
    this.supabase = supabase;
  }

  /**
   * í’ˆëª©ë³„ ì¬ê³  ê¸ˆì•¡ ê³„ì‚° (ì§€ì • ì›” ê¸°ì¤€)
   */
  async calculateItemValuation(
    targetMonth: string,  // YYYY-MM-01
    options: {
      itemIds?: number[];
      category?: string;
      supplierId?: number;
      minStock?: number;
    } = {}
  ): Promise<StockValuationResult[]> {
    const cacheKey = `${targetMonth}_${JSON.stringify(options)}`;

    // ìºì‹œ í™•ì¸ (5ë¶„)
    if (this.valuationCache.has(cacheKey)) {
      const cached = this.valuationCache.get(cacheKey)!;
      console.log('[StockValueCalculator] Using cached valuation');
      return cached;
    }

    // í’ˆëª©ë³„ ë‹¨ê°€ ì¡°íšŒ (PostgreSQL í•¨ìˆ˜ ì‚¬ìš©)
    const { data: items, error } = await this.supabase.rpc(
      'get_current_item_prices',
      {
        p_target_month: targetMonth,
        p_category: options.category || null,
        p_supplier_id: options.supplierId || null
      }
    );

    if (error) {
      throw new Error(`Failed to get item prices: ${error.message}`);
    }

    if (!items) {
      return [];
    }

    // ì¬ê³  ê¸ˆì•¡ ê³„ì‚°
    const valuations: StockValuationResult[] = items
      .filter(item => {
        if (options.itemIds && !options.itemIds.includes(item.item_id)) {
          return false;
        }
        if (options.minStock && item.current_stock < options.minStock) {
          return false;
        }
        return true;
      })
      .map(item => ({
        item_id: item.item_id,
        item_code: item.item_code,
        item_name: item.item_name,
        current_stock: item.current_stock,
        unit_price: parseFloat(item.unit_price || '0'),
        stock_value: item.current_stock * parseFloat(item.unit_price || '0'),
        price_month: item.price_month || targetMonth,
        is_historical_price: item.is_historical || false
      }));

    // ìºì‹œ ì €ì¥ (5ë¶„ TTL)
    this.valuationCache.set(cacheKey, valuations);
    setTimeout(() => this.valuationCache.delete(cacheKey), 5 * 60 * 1000);

    return valuations;
  }

  /**
   * ì¹´í…Œê³ ë¦¬ë³„ ì¬ê³  ê¸ˆì•¡ ì§‘ê³„
   */
  async calculateCategoryValuation(
    targetMonth: string
  ): Promise<CategoryValuationResult[]> {
    // v_stock_value_by_category ë·° ì¡°íšŒ
    const { data, error } = await this.supabase
      .from('v_stock_value_by_category')
      .select('*')
      .order('total_value', { ascending: false });

    if (error) {
      throw new Error(`Failed to get category valuation: ${error.message}`);
    }

    return (data || []).map(cat => ({
      inventory_category: cat.inventory_category,
      item_count: cat.item_count,
      total_quantity: cat.total_quantity,
      total_value: parseFloat(cat.total_value || '0')
    }));
  }

  /**
   * ì—…ì²´ë³„ ì¬ê³  ê¸ˆì•¡ ì§‘ê³„
   */
  async calculateSupplierValuation(
    targetMonth: string
  ): Promise<Array<{
    supplier_name: string;
    company_category: string;
    item_count: number;
    total_stock_value: number;
  }>> {
    // v_stock_valuation_monthly ë·° ê¸°ë°˜ ì§‘ê³„
    const { data, error } = await this.supabase
      .from('v_stock_valuation_monthly')
      .select('supplier_name, company_category, stock_value');

    if (error) {
      throw new Error(`Failed to get supplier valuation: ${error.message}`);
    }

    // ì—…ì²´ë³„ ê·¸ë£¹í•‘
    const supplierMap = new Map<string, {
      supplier_name: string;
      company_category: string;
      item_count: number;
      total_stock_value: number;
    }>();

    (data || []).forEach(item => {
      const key = item.supplier_name || 'Unknown';
      if (!supplierMap.has(key)) {
        supplierMap.set(key, {
          supplier_name: key,
          company_category: item.company_category || '',
          item_count: 0,
          total_stock_value: 0
        });
      }
      const supplier = supplierMap.get(key)!;
      supplier.item_count += 1;
      supplier.total_stock_value += parseFloat(item.stock_value || '0');
    });

    return Array.from(supplierMap.values())
      .sort((a, b) => b.total_stock_value - a.total_stock_value);
  }

  /**
   * ì›”ë³„ ì¬ê³  ê¸ˆì•¡ ì¶”ì´ (3ê°œì›”~12ê°œì›”)
   */
  async calculateMonthlyTrend(
    months: number = 6  // ê¸°ë³¸ 6ê°œì›”
  ): Promise<Array<{
    month: string;
    total_stock_value: number;
    raw_material_value: number;
    sub_material_value: number;
    finished_goods_value: number;
    wip_value: number;
  }>> {
    const results = [];
    const today = new Date();

    for (let i = 0; i < months; i++) {
      const targetDate = new Date(today.getFullYear(), today.getMonth() - i, 1);
      const monthStr = targetDate.toISOString().slice(0, 7) + '-01';

      // ì¹´í…Œê³ ë¦¬ë³„ ì¬ê³  ê¸ˆì•¡ ì¡°íšŒ
      const categories = await this.calculateCategoryValuation(monthStr);

      const monthData = {
        month: monthStr,
        total_stock_value: categories.reduce((sum, cat) => sum + cat.total_value, 0),
        raw_material_value: categories.find(c => c.inventory_category === 'ì›ìì¬')?.total_value || 0,
        sub_material_value: categories.find(c => c.inventory_category === 'ë¶€ìì¬')?.total_value || 0,
        finished_goods_value: categories.find(c => c.inventory_category === 'ì™„ì œí’ˆ')?.total_value || 0,
        wip_value: categories.find(c => c.inventory_category === 'ê³µì •ì¬ê³ ')?.total_value || 0
      };

      results.push(monthData);
    }

    return results.reverse();  // ì˜¤ë˜ëœ ê²ƒë¶€í„°
  }

  /**
   * ìºì‹œ ì´ˆê¸°í™”
   */
  clearCache(): void {
    this.valuationCache.clear();
    console.log('[StockValueCalculator] Cache cleared');
  }
}
```

#### ê²€ì¦ ê¸°ì¤€
- [ ] í´ë˜ìŠ¤ ë™ì‘ í™•ì¸ (ëª¨ë“  ë©”ì„œë“œ í…ŒìŠ¤íŠ¸)
- [ ] ì¬ê³  ê¸ˆì•¡ ê³„ì‚° ì •í™•ë„ ê²€ì¦
- [ ] ìºì‹œ ë™ì‘ í™•ì¸ (5ë¶„ TTL)
- [ ] ì›”ë³„ ì¶”ì´ ê³„ì‚° ì •í™•ë„ ê²€ì¦ (6ê°œì›”)
- [ ] ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ (1000ê°œ í’ˆëª© < 2ì´ˆ)

---

### Task 2.2: ì›”ë³„ ì¬ë¬´ ì§‘ê³„ ë¡œì§ (backend-architect)
**ë‹´ë‹¹ ì—ì´ì „íŠ¸**: `backend-architect`
**ìš°ì„ ìˆœìœ„**: P1
**ì†Œìš” ì‹œê°„**: 6-8ì‹œê°„

#### ì›”ë³„ ì¬ë¬´ ì§‘ê³„ í´ë˜ìŠ¤
```typescript
// src/lib/monthly-financial-aggregator.ts
import { SupabaseClient } from '@supabase/supabase-js';
import { Database } from '@/types/supabase';

interface DailySummary {
  date: string;
  day: number;
  sales: number;
  purchases: number;
  collections: number;
  payments: number;
  net_cash_flow: number;
  cumulative_cash_flow: number;
}

interface CompanySummary {
  company_name: string;
  company_category: string;
  total_amount: number;
  paid_amount: number;
  outstanding: number;
  transaction_count: number;
}

export class MonthlyFinancialAggregator {
  private supabase: SupabaseClient<Database>;

  constructor(supabase: SupabaseClient<Database>) {
    this.supabase = supabase;
  }

  /**
   * ì¼ë³„ ì¬ë¬´ ì§‘ê³„ (1ì¼~30ì¼)
   */
  async generateDailySummary(
    year: string,
    month: string
  ): Promise<DailySummary[]> {
    const startDate = `${year}-${month.padStart(2, '0')}-01`;
    const daysInMonth = new Date(parseInt(year), parseInt(month), 0).getDate();
    const endDate = `${year}-${month.padStart(2, '0')}-${daysInMonth.toString().padStart(2, '0')}`;

    // ë³‘ë ¬ ì¡°íšŒ (4ê°œ í…Œì´ë¸”)
    const [salesRes, purchasesRes, collectionsRes, paymentsRes] = await Promise.all([
      this.supabase
        .from('sales_transactions')
        .select('transaction_date, total_amount')
        .gte('transaction_date', startDate)
        .lte('transaction_date', endDate),

      this.supabase
        .from('purchase_transactions')
        .select('transaction_date, total_amount')
        .gte('transaction_date', startDate)
        .lte('transaction_date', endDate),

      this.supabase
        .from('collections')
        .select('collection_date, amount')
        .gte('collection_date', startDate)
        .lte('collection_date', endDate),

      this.supabase
        .from('payments')
        .select('payment_date, amount')
        .gte('payment_date', startDate)
        .lte('payment_date', endDate)
    ]);

    const sales = salesRes.data || [];
    const purchases = purchasesRes.data || [];
    const collections = collectionsRes.data || [];
    const payments = paymentsRes.data || [];

    // ì¼ë³„ ì§‘ê³„ ìƒì„±
    const daily: DailySummary[] = [];
    let cumulativeCashFlow = 0;

    for (let day = 1; day <= daysInMonth; day++) {
      const dateStr = `${year}-${month.padStart(2, '0')}-${day.toString().padStart(2, '0')}`;

      const daySales = this.sumByDate(sales, 'transaction_date', dateStr);
      const dayPurchases = this.sumByDate(purchases, 'transaction_date', dateStr);
      const dayCollections = this.sumByDate(collections, 'collection_date', dateStr);
      const dayPayments = this.sumByDate(payments, 'payment_date', dateStr);
      const netCashFlow = dayCollections - dayPayments;
      cumulativeCashFlow += netCashFlow;

      daily.push({
        date: dateStr,
        day,
        sales: daySales,
        purchases: dayPurchases,
        collections: dayCollections,
        payments: dayPayments,
        net_cash_flow: netCashFlow,
        cumulative_cash_flow: cumulativeCashFlow
      });
    }

    return daily;
  }

  /**
   * ê³ ê°ì‚¬ë³„ ì§‘ê³„
   */
  async aggregateCustomers(
    year: string,
    month: string
  ): Promise<CompanySummary[]> {
    const startDate = `${year}-${month.padStart(2, '0')}-01`;
    const daysInMonth = new Date(parseInt(year), parseInt(month), 0).getDate();
    const endDate = `${year}-${month.padStart(2, '0')}-${daysInMonth.toString().padStart(2, '0')}`;

    // ë§¤ì¶œ ê±°ë˜
    const { data: sales } = await this.supabase
      .from('sales_transactions')
      .select('customer_id, total_amount, customer:companies!customer_id(company_name, company_category)')
      .gte('transaction_date', startDate)
      .lte('transaction_date', endDate);

    // ìˆ˜ê¸ˆ ë‚´ì—­
    const { data: collections } = await this.supabase
      .from('collections')
      .select('customer_id, amount')
      .gte('collection_date', startDate)
      .lte('collection_date', endDate);

    return this.aggregateByCompany(sales || [], collections || [], 'customer_id');
  }

  /**
   * í˜‘ë ¥ì‚¬ë³„ ì§‘ê³„
   */
  async aggregateSuppliers(
    year: string,
    month: string
  ): Promise<CompanySummary[]> {
    const startDate = `${year}-${month.padStart(2, '0')}-01`;
    const daysInMonth = new Date(parseInt(year), parseInt(month), 0).getDate();
    const endDate = `${year}-${month.padStart(2, '0')}-${daysInMonth.toString().padStart(2, '0')}`;

    // ë§¤ì… ê±°ë˜
    const { data: purchases } = await this.supabase
      .from('purchase_transactions')
      .select('supplier_id, total_amount, supplier:companies!supplier_id(company_name, company_category)')
      .gte('transaction_date', startDate)
      .lte('transaction_date', endDate);

    // ì§€ê¸‰ ë‚´ì—­
    const { data: payments } = await this.supabase
      .from('payments')
      .select('supplier_id, amount')
      .gte('payment_date', startDate)
      .lte('payment_date', endDate);

    return this.aggregateByCompany(purchases || [], payments || [], 'supplier_id');
  }

  // Helper: ë‚ ì§œë³„ ê¸ˆì•¡ í•©ê³„
  private sumByDate(
    records: Array<{ [key: string]: any }>,
    dateField: string,
    targetDate: string
  ): number {
    return records
      .filter(r => r[dateField] === targetDate)
      .reduce((sum, r) => sum + parseFloat(r.total_amount || r.amount || '0'), 0);
  }

  // Helper: ì—…ì²´ë³„ ì§‘ê³„
  private aggregateByCompany(
    transactions: any[],
    payments: any[],
    companyIdField: string
  ): CompanySummary[] {
    const companyMap = new Map<number, CompanySummary>();

    // ê±°ë˜ ê¸ˆì•¡ ì§‘ê³„
    transactions.forEach(t => {
      const companyId = t[companyIdField];
      const company = t.customer || t.supplier;
      if (!companyId || !company) return;

      if (!companyMap.has(companyId)) {
        companyMap.set(companyId, {
          company_name: company.company_name,
          company_category: company.company_category || '',
          total_amount: 0,
          paid_amount: 0,
          outstanding: 0,
          transaction_count: 0
        });
      }
      const entry = companyMap.get(companyId)!;
      entry.total_amount += parseFloat(t.total_amount || '0');
      entry.transaction_count += 1;
    });

    // ì§€ê¸‰/ìˆ˜ê¸ˆ ê¸ˆì•¡ ì§‘ê³„
    payments.forEach(p => {
      const companyId = p[companyIdField];
      if (!companyId || !companyMap.has(companyId)) return;

      const entry = companyMap.get(companyId)!;
      entry.paid_amount += parseFloat(p.amount || '0');
    });

    // ë¯¸ìˆ˜ê¸ˆ/ë¯¸ì§€ê¸‰ê¸ˆ ê³„ì‚°
    companyMap.forEach((entry) => {
      entry.outstanding = entry.total_amount - entry.paid_amount;
    });

    return Array.from(companyMap.values())
      .sort((a, b) => b.total_amount - a.total_amount);
  }
}
```

#### ê²€ì¦ ê¸°ì¤€
- [ ] í´ë˜ìŠ¤ ë™ì‘ í™•ì¸
- [ ] ì¼ë³„ ì§‘ê³„ ì •í™•ë„ ê²€ì¦ (ëˆ„ì  í˜„ê¸ˆ íë¦„)
- [ ] ì—…ì²´ë³„ ì§‘ê³„ ì •í™•ë„ ê²€ì¦ (ë¯¸ìˆ˜ê¸ˆ/ë¯¸ì§€ê¸‰ê¸ˆ)
- [ ] ë³‘ë ¬ ì¡°íšŒ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ (4ê°œ í…Œì´ë¸” ë™ì‹œ ì¡°íšŒ < 1ì´ˆ)
- [ ] Excel ì •ë¦¬ ë³´ë“œ ë°ì´í„°ì™€ ë¹„êµ

---

### Task 2.3: Excel Export ê¸°ëŠ¥ - ì •ë¦¬ ë³´ë“œ (erp-specialist)
**ë‹´ë‹¹ ì—ì´ì „íŠ¸**: `erp-specialist`
**ìš°ì„ ìˆœìœ„**: P2
**ì†Œìš” ì‹œê°„**: 4-6ì‹œê°„

#### Excel Export API (ì •ë¦¬ ë³´ë“œ í˜•ì‹)
```typescript
// src/app/api/export/financial-summary/route.ts
import { NextRequest } from 'next/server';
import * as XLSX from 'xlsx';
import { getSupabaseClient } from '@/lib/db-unified';
import { MonthlyFinancialAggregator } from '@/lib/monthly-financial-aggregator';
import { StockValueCalculator } from '@/lib/stock-value-calculator';

export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url);
    const year = searchParams.get('year') || new Date().getFullYear().toString();
    const month = searchParams.get('month') || (new Date().getMonth() + 1).toString();

    const supabase = getSupabaseClient();
    const financialAgg = new MonthlyFinancialAggregator(supabase);
    const stockCalc = new StockValueCalculator(supabase);

    // ë°ì´í„° ìˆ˜ì§‘ (ë³‘ë ¬)
    const [daily, customers, suppliers, categoryValuation] = await Promise.all([
      financialAgg.generateDailySummary(year, month),
      financialAgg.aggregateCustomers(year, month),
      financialAgg.aggregateSuppliers(year, month),
      stockCalc.calculateCategoryValuation(`${year}-${month.padStart(2, '0')}-01`)
    ]);

    const workbook = XLSX.utils.book_new();

    // Sheet 1: ë©”íƒ€ë°ì´í„°
    const metaSheet = XLSX.utils.aoa_to_sheet([
      ['ì›”ë³„ ì¬ë¬´ ì •ë¦¬ ë³´ë“œ', ''],
      ['ê¸°ì¤€ ë…„ì›”', `${year}ë…„ ${month}ì›”`],
      ['ë‚´ë³´ë‚¸ ë‚ ì§œ', new Date().toLocaleString('ko-KR')],
      ['ì‘ì„±ì', 'SuperClaude ERP']
    ]);

    // Sheet 2: ì¼ë³„ ì§‘ê³„ (1ì¼~30ì¼)
    const dailyData = daily.map(d => ({
      'ì¼ì': d.date,
      'ì¼': d.day,
      'ë§¤ì¶œ': d.sales,
      'ë§¤ì…': d.purchases,
      'ìˆ˜ê¸ˆ': d.collections,
      'ì§€ê¸‰': d.payments,
      'ë‹¹ì¼ í˜„ê¸ˆíë¦„': d.net_cash_flow,
      'ëˆ„ì  í˜„ê¸ˆíë¦„': d.cumulative_cash_flow
    }));
    const dailySheet = XLSX.utils.json_to_sheet(dailyData);

    // Sheet 3: ê³ ê°ì‚¬ë³„ ì§‘ê³„
    const customerData = customers.map(c => ({
      'ê³ ê°ì‚¬ëª…': c.company_name,
      'ë¶„ë¥˜': c.company_category,
      'ë§¤ì¶œê¸ˆì•¡': c.total_amount,
      'ìˆ˜ê¸ˆê¸ˆì•¡': c.paid_amount,
      'ë¯¸ìˆ˜ê¸ˆ': c.outstanding,
      'ê±°ë˜ê±´ìˆ˜': c.transaction_count
    }));
    const customerSheet = XLSX.utils.json_to_sheet(customerData);

    // Sheet 4: í˜‘ë ¥ì‚¬ë³„ ì§‘ê³„
    const supplierData = suppliers.map(s => ({
      'í˜‘ë ¥ì‚¬ëª…': s.company_name,
      'ë¶„ë¥˜': s.company_category,
      'ë§¤ì…ê¸ˆì•¡': s.total_amount,
      'ì§€ê¸‰ê¸ˆì•¡': s.paid_amount,
      'ë¯¸ì§€ê¸‰ê¸ˆ': s.outstanding,
      'ê±°ë˜ê±´ìˆ˜': s.transaction_count
    }));
    const supplierSheet = XLSX.utils.json_to_sheet(supplierData);

    // Sheet 5: ì¬ê³  ê¸ˆì•¡ (ì¹´í…Œê³ ë¦¬ë³„)
    const stockData = categoryValuation.map(cat => ({
      'ì¬ê³ ë¶„ë¥˜': cat.inventory_category,
      'í’ˆëª©ìˆ˜': cat.item_count,
      'ì´ìˆ˜ëŸ‰': cat.total_quantity,
      'ì¬ê³ ê¸ˆì•¡': cat.total_value
    }));
    const stockSheet = XLSX.utils.json_to_sheet(stockData);

    // Sheet 6: ì›”ë³„ ìš”ì•½
    const totalSales = daily.reduce((sum, d) => sum + d.sales, 0);
    const totalPurchases = daily.reduce((sum, d) => sum + d.purchases, 0);
    const totalCollections = daily.reduce((sum, d) => sum + d.collections, 0);
    const totalPayments = daily.reduce((sum, d) => sum + d.payments, 0);
    const totalStockValue = categoryValuation.reduce((sum, cat) => sum + cat.total_value, 0);

    const summarySheet = XLSX.utils.aoa_to_sheet([
      ['í•­ëª©', 'ê¸ˆì•¡'],
      ['ì´ ë§¤ì¶œ', totalSales],
      ['ì´ ë§¤ì…', totalPurchases],
      ['ì´ ìˆ˜ê¸ˆ', totalCollections],
      ['ì´ ì§€ê¸‰', totalPayments],
      ['ìˆœ í˜„ê¸ˆíë¦„', totalCollections - totalPayments],
      ['ì¬ê³  ê¸ˆì•¡', totalStockValue]
    ]);

    // ì›Œí¬ë¶ ì¡°ë¦½
    XLSX.utils.book_append_sheet(workbook, metaSheet, 'ë©”íƒ€ë°ì´í„°');
    XLSX.utils.book_append_sheet(workbook, dailySheet, 'ì¼ë³„ì§‘ê³„');
    XLSX.utils.book_append_sheet(workbook, customerSheet, 'ê³ ê°ì‚¬ì§‘ê³„');
    XLSX.utils.book_append_sheet(workbook, supplierSheet, 'í˜‘ë ¥ì‚¬ì§‘ê³„');
    XLSX.utils.book_append_sheet(workbook, stockSheet, 'ì¬ê³ ê¸ˆì•¡');
    XLSX.utils.book_append_sheet(workbook, summarySheet, 'ì›”ë³„ìš”ì•½');

    const buffer = XLSX.write(workbook, { type: 'buffer', bookType: 'xlsx' });

    return new Response(buffer, {
      headers: {
        'Content-Type': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'Content-Disposition': `attachment; filename="ì¬ë¬´ì •ë¦¬ë³´ë“œ_${year}ë…„${month}ì›”.xlsx"`
      }
    });
  } catch (error) {
    console.error('[API] financial summary export error:', error);
    return Response.json(
      { success: false, error: 'Export failed' },
      { status: 500 }
    );
  }
}
```

#### ê²€ì¦ ê¸°ì¤€
- [ ] Excel Export ë™ì‘ í™•ì¸ (6ê°œ ì‹œíŠ¸)
- [ ] í•œê¸€ í—¤ë” ì¸ì½”ë”© í™•ì¸
- [ ] ë°ì´í„° ì •í™•ë„ ê²€ì¦ (ìˆ˜ë™ ì§‘ê³„ì™€ ë¹„êµ)
- [ ] íŒŒì¼ í¬ê¸° ìµœì í™” (<5MB, 1000ê°œ í’ˆëª© ê¸°ì¤€)
- [ ] ë‹¤ìš´ë¡œë“œ ì†ë„ (<5ì´ˆ)

---

## ğŸ“‹ Wave 3: í”„ë¡ íŠ¸ì—”ë“œ UI + ëŒ€ì‹œë³´ë“œ (4-5ì¼)

### Task 3.1: ì›”ë³„ ë‹¨ê°€ ê´€ë¦¬ í˜ì´ì§€ (frontend-developer)
**ë‹´ë‹¹ ì—ì´ì „íŠ¸**: `frontend-developer`
**ìš°ì„ ìˆœìœ„**: P0
**ì†Œìš” ì‹œê°„**: 8-10ì‹œê°„

#### ì›”ë³„ ë‹¨ê°€ ê´€ë¦¬ í˜ì´ì§€
```typescript
// src/app/price-management/page.tsx
'use client';

import { useState, useEffect } from 'react';
import { useToast } from '@/components/ui/use-toast';
import MainLayout from '@/components/layout/MainLayout';

interface PriceHistory {
  price_history_id: number;
  item_id: number;
  item: {
    item_code: string;
    item_name: string;
    spec: string;
    category: string;
  };
  price_month: string;
  unit_price: number;
  price_per_kg?: number;
  note?: string;
}

export default function PriceManagementPage() {
  const [selectedMonth, setSelectedMonth] = useState<string>(
    new Date().toISOString().slice(0, 7)
  );
  const [prices, setPrices] = useState<PriceHistory[]>([]);
  const [loading, setLoading] = useState(false);
  const [editingId, setEditingId] = useState<number | null>(null);
  const { toast } = useToast();

  // ì›”ë³„ ë‹¨ê°€ ì¡°íšŒ
  const fetchPrices = async () => {
    setLoading(true);
    try {
      const res = await fetch(`/api/price-history/current?month=${selectedMonth}-01`);
      const data = await res.json();

      if (data.success) {
        setPrices(data.data.items || []);
      } else {
        toast({
          title: 'ì¡°íšŒ ì‹¤íŒ¨',
          description: data.error,
          variant: 'destructive'
        });
      }
    } catch (error) {
      console.error('Price fetch error:', error);
      toast({
        title: 'ì¡°íšŒ ì‹¤íŒ¨',
        description: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
        variant: 'destructive'
      });
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchPrices();
  }, [selectedMonth]);

  // ë‹¨ê°€ ìˆ˜ì •
  const handlePriceUpdate = async (
    priceHistoryId: number,
    updates: Partial<PriceHistory>
  ) => {
    try {
      const res = await fetch(`/api/price-history/${priceHistoryId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updates)
      });

      const data = await res.json();

      if (data.success) {
        toast({
          title: 'ìˆ˜ì • ì™„ë£Œ',
          description: 'ë‹¨ê°€ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤',
          variant: 'default'
        });
        fetchPrices();
        setEditingId(null);
      } else {
        toast({
          title: 'ìˆ˜ì • ì‹¤íŒ¨',
          description: data.error,
          variant: 'destructive'
        });
      }
    } catch (error) {
      console.error('Price update error:', error);
      toast({
        title: 'ìˆ˜ì • ì‹¤íŒ¨',
        description: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
        variant: 'destructive'
      });
    }
  };

  // Excel Import
  const handleExcelImport = async (file: File) => {
    const formData = new FormData();
    formData.append('file', file);

    try {
      const res = await fetch('/api/upload/price-history', {
        method: 'POST',
        body: formData
      });

      const data = await res.json();

      if (data.success) {
        toast({
          title: 'Import ì™„ë£Œ',
          description: `${data.data.imported_count}ê°œ í’ˆëª© ë‹¨ê°€ ë“±ë¡ ì™„ë£Œ`,
          variant: 'default'
        });
        fetchPrices();
      } else {
        toast({
          title: 'Import ì‹¤íŒ¨',
          description: data.error,
          variant: 'destructive'
        });
      }
    } catch (error) {
      console.error('Excel import error:', error);
      toast({
        title: 'Import ì‹¤íŒ¨',
        description: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
        variant: 'destructive'
      });
    }
  };

  return (
    <MainLayout>
      <div className="container mx-auto p-6 space-y-6">
        {/* í—¤ë” */}
        <div className="flex justify-between items-center">
          <h1 className="text-3xl font-bold">ì›”ë³„ ë‹¨ê°€ ê´€ë¦¬</h1>

          <div className="flex gap-4 items-center">
            {/* ì›” ì„ íƒ */}
            <input
              type="month"
              value={selectedMonth}
              onChange={(e) => setSelectedMonth(e.target.value)}
              className="px-4 py-2 border rounded-lg"
            />

            {/* Excel í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ */}
            <a
              href="/api/download/template/price-history"
              download
              className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
            >
              Excel í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
            </a>

            {/* Excel Import */}
            <label className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 cursor-pointer">
              Excel Import
              <input
                type="file"
                accept=".xlsx,.xls"
                className="hidden"
                onChange={(e) => {
                  if (e.target.files?.[0]) {
                    handleExcelImport(e.target.files[0]);
                  }
                }}
              />
            </label>
          </div>
        </div>

        {/* ë‹¨ê°€ í…Œì´ë¸” */}
        <div className="bg-white rounded-lg shadow overflow-hidden">
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">í’ˆëª©ì½”ë“œ</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">í’ˆëª©ëª…</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ê·œê²©</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ë¶„ë¥˜</th>
                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">í˜„ì¬ ì¬ê³ </th>
                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">ë‹¨ê°€ (â‚©)</th>
                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">ì¬ê³  ê¸ˆì•¡ (â‚©)</th>
                <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">ê¸°ì¤€ì›”</th>
                <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">ì•¡ì…˜</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {loading ? (
                <tr>
                  <td colSpan={9} className="px-6 py-4 text-center">ë¡œë”© ì¤‘...</td>
                </tr>
              ) : prices.length === 0 ? (
                <tr>
                  <td colSpan={9} className="px-6 py-4 text-center">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td>
                </tr>
              ) : (
                prices.map((price) => (
                  <tr key={price.price_history_id} className="hover:bg-gray-50">
                    <td className="px-6 py-4 whitespace-nowrap text-sm">{price.item.item_code}</td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">{price.item.item_name}</td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm">{price.item.spec}</td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm">{price.item.category}</td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-right">
                      {price.item.current_stock?.toLocaleString('ko-KR')}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-right">
                      {editingId === price.price_history_id ? (
                        <input
                          type="number"
                          defaultValue={price.unit_price}
                          className="w-full px-2 py-1 border rounded text-right"
                          onBlur={(e) => {
                            handlePriceUpdate(price.price_history_id, {
                              unit_price: parseFloat(e.target.value)
                            });
                          }}
                          autoFocus
                        />
                      ) : (
                        <span>{price.unit_price.toLocaleString('ko-KR')}</span>
                      )}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-right font-semibold">
                      {(price.unit_price * (price.item.current_stock || 0)).toLocaleString('ko-KR')}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-center">
                      {price.price_month?.slice(0, 7)}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-center">
                      <button
                        onClick={() => setEditingId(price.price_history_id)}
                        className="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700"
                      >
                        ìˆ˜ì •
                      </button>
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </div>
    </MainLayout>
  );
}
```

#### ê²€ì¦ ê¸°ì¤€
- [ ] í˜ì´ì§€ ë Œë”ë§ í™•ì¸
- [ ] ì›” ì„ íƒ ê¸°ëŠ¥ ë™ì‘ í™•ì¸
- [ ] ë‹¨ê°€ ìˆ˜ì • ê¸°ëŠ¥ ë™ì‘ í™•ì¸
- [ ] Excel Import ë™ì‘ í™•ì¸
- [ ] ì¬ê³  ê¸ˆì•¡ ìë™ ê³„ì‚° í™•ì¸

---

### Task 3.2: ì¬ê³  ê¸ˆì•¡ ëŒ€ì‹œë³´ë“œ (frontend-developer)
**ë‹´ë‹¹ ì—ì´ì „íŠ¸**: `frontend-developer`
**ìš°ì„ ìˆœìœ„**: P1
**ì†Œìš” ì‹œê°„**: 8-10ì‹œê°„

#### ì¬ê³  ê¸ˆì•¡ ëŒ€ì‹œë³´ë“œ í˜ì´ì§€
```typescript
// src/app/stock/valuation/page.tsx
'use client';

import { useState, useEffect } from 'react';
import MainLayout from '@/components/layout/MainLayout';
import { PieChart, Pie, Cell, ResponsiveContainer, Legend, Tooltip } from 'recharts';
import { useToast } from '@/components/ui/use-toast';

interface CategoryValuation {
  inventory_category: string;
  item_count: number;
  total_quantity: number;
  total_value: number;
}

interface SupplierValuation {
  supplier_name: string;
  company_category: string;
  item_count: number;
  total_stock_value: number;
}

const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884D8'];

export default function StockValuationPage() {
  const [selectedMonth, setSelectedMonth] = useState<string>(
    new Date().toISOString().slice(0, 7)
  );
  const [categories, setCategories] = useState<CategoryValuation[]>([]);
  const [suppliers, setSuppliers] = useState<SupplierValuation[]>([]);
  const [loading, setLoading] = useState(false);
  const { toast } = useToast();

  // ì¬ê³  ê¸ˆì•¡ ì¡°íšŒ
  const fetchValuation = async () => {
    setLoading(true);
    try {
      const [catRes, supRes] = await Promise.all([
        fetch(`/api/stock/valuation/category?month=${selectedMonth}-01`),
        fetch(`/api/stock/valuation/supplier?month=${selectedMonth}-01`)
      ]);

      const [catData, supData] = await Promise.all([
        catRes.json(),
        supRes.json()
      ]);

      if (catData.success) {
        setCategories(catData.data.categories || []);
      }
      if (supData.success) {
        setSuppliers(supData.data.suppliers || []);
      }
    } catch (error) {
      console.error('Valuation fetch error:', error);
      toast({
        title: 'ì¡°íšŒ ì‹¤íŒ¨',
        description: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
        variant: 'destructive'
      });
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchValuation();
  }, [selectedMonth]);

  const totalValue = categories.reduce((sum, cat) => sum + cat.total_value, 0);

  // Excel Export
  const handleExcelExport = async () => {
    window.open(
      `/api/export/financial-summary?year=${selectedMonth.slice(0, 4)}&month=${selectedMonth.slice(5, 7)}`,
      '_blank'
    );
  };

  return (
    <MainLayout>
      <div className="container mx-auto p-6 space-y-6">
        {/* í—¤ë” */}
        <div className="flex justify-between items-center">
          <h1 className="text-3xl font-bold">ì¬ê³  ê¸ˆì•¡ í˜„í™©</h1>

          <div className="flex gap-4 items-center">
            <input
              type="month"
              value={selectedMonth}
              onChange={(e) => setSelectedMonth(e.target.value)}
              className="px-4 py-2 border rounded-lg"
            />

            <button
              onClick={handleExcelExport}
              className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
            >
              Excel Export
            </button>
          </div>
        </div>

        {/* KPI ì¹´ë“œ */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
          <div className="bg-white p-6 rounded-lg shadow">
            <div className="text-sm text-gray-500">ì´ ì¬ê³  ê¸ˆì•¡</div>
            <div className="text-3xl font-bold mt-2">
              {totalValue.toLocaleString('ko-KR')} ì›
            </div>
          </div>
          <div className="bg-white p-6 rounded-lg shadow">
            <div className="text-sm text-gray-500">ì›ìì¬</div>
            <div className="text-3xl font-bold mt-2 text-blue-600">
              {(categories.find(c => c.inventory_category === 'ì›ìì¬')?.total_value || 0).toLocaleString('ko-KR')} ì›
            </div>
          </div>
          <div className="bg-white p-6 rounded-lg shadow">
            <div className="text-sm text-gray-500">ë¶€ìì¬</div>
            <div className="text-3xl font-bold mt-2 text-green-600">
              {(categories.find(c => c.inventory_category === 'ë¶€ìì¬')?.total_value || 0).toLocaleString('ko-KR')} ì›
            </div>
          </div>
          <div className="bg-white p-6 rounded-lg shadow">
            <div className="text-sm text-gray-500">ì™„ì œí’ˆ</div>
            <div className="text-3xl font-bold mt-2 text-orange-600">
              {(categories.find(c => c.inventory_category === 'ì™„ì œí’ˆ')?.total_value || 0).toLocaleString('ko-KR')} ì›
            </div>
          </div>
        </div>

        {/* ì°¨íŠ¸ ì˜ì—­ */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          {/* ì¹´í…Œê³ ë¦¬ë³„ ì›í˜• ì°¨íŠ¸ */}
          <div className="bg-white p-6 rounded-lg shadow">
            <h2 className="text-xl font-bold mb-4">ì¹´í…Œê³ ë¦¬ë³„ ì¬ê³  ê¸ˆì•¡</h2>
            <ResponsiveContainer width="100%" height={300}>
              <PieChart>
                <Pie
                  data={categories}
                  dataKey="total_value"
                  nameKey="inventory_category"
                  cx="50%"
                  cy="50%"
                  outerRadius={100}
                  label={(entry) => `${entry.inventory_category}: ${(entry.total_value / totalValue * 100).toFixed(1)}%`}
                >
                  {categories.map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                  ))}
                </Pie>
                <Tooltip />
                <Legend />
              </PieChart>
            </ResponsiveContainer>
          </div>

          {/* ì—…ì²´ë³„ í…Œì´ë¸” */}
          <div className="bg-white p-6 rounded-lg shadow">
            <h2 className="text-xl font-bold mb-4">ì—…ì²´ë³„ ì¬ê³  ê¸ˆì•¡ (Top 10)</h2>
            <div className="overflow-y-auto max-h-[300px]">
              <table className="min-w-full">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500">ì—…ì²´ëª…</th>
                    <th className="px-4 py-2 text-right text-xs font-medium text-gray-500">í’ˆëª©ìˆ˜</th>
                    <th className="px-4 py-2 text-right text-xs font-medium text-gray-500">ì¬ê³  ê¸ˆì•¡</th>
                  </tr>
                </thead>
                <tbody>
                  {suppliers.slice(0, 10).map((sup, index) => (
                    <tr key={index} className="border-b">
                      <td className="px-4 py-2 text-sm">{sup.supplier_name}</td>
                      <td className="px-4 py-2 text-sm text-right">{sup.item_count}</td>
                      <td className="px-4 py-2 text-sm text-right font-semibold">
                        {sup.total_stock_value.toLocaleString('ko-KR')}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        {/* ì¹´í…Œê³ ë¦¬ ìƒì„¸ í…Œì´ë¸” */}
        <div className="bg-white p-6 rounded-lg shadow">
          <h2 className="text-xl font-bold mb-4">ì¹´í…Œê³ ë¦¬ë³„ ìƒì„¸</h2>
          <table className="min-w-full">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500">ì¬ê³  ë¶„ë¥˜</th>
                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500">í’ˆëª© ìˆ˜</th>
                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500">ì´ ìˆ˜ëŸ‰</th>
                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500">ì¬ê³  ê¸ˆì•¡</th>
                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500">ë¹„ì¤‘ (%)</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-200">
              {categories.map((cat, index) => (
                <tr key={index} className="hover:bg-gray-50">
                  <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">{cat.inventory_category}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-right">{cat.item_count}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-right">{cat.total_quantity.toLocaleString('ko-KR')}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-right font-semibold">
                    {cat.total_value.toLocaleString('ko-KR')} ì›
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-right">
                    {((cat.total_value / totalValue) * 100).toFixed(1)} %
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </MainLayout>
  );
}
```

#### ê²€ì¦ ê¸°ì¤€
- [ ] í˜ì´ì§€ ë Œë”ë§ í™•ì¸
- [ ] KPI ì¹´ë“œ ë°ì´í„° í™•ì¸
- [ ] ì›í˜• ì°¨íŠ¸ ë Œë”ë§ í™•ì¸
- [ ] ì—…ì²´ë³„/ì¹´í…Œê³ ë¦¬ë³„ í…Œì´ë¸” í™•ì¸
- [ ] Excel Export ë™ì‘ í™•ì¸

---

### Task 3.3: ì›”ë³„ ì¬ë¬´ ì •ë¦¬ ë³´ë“œ í˜ì´ì§€ (frontend-developer)
**ë‹´ë‹¹ ì—ì´ì „íŠ¸**: `frontend-developer`
**ìš°ì„ ìˆœìœ„**: P1
**ì†Œìš” ì‹œê°„**: 8-10ì‹œê°„

#### ì›”ë³„ ì¬ë¬´ ì •ë¦¬ ë³´ë“œ
```typescript
// src/app/financial/summary/page.tsx
'use client';

import { useState, useEffect } from 'react';
import MainLayout from '@/components/layout/MainLayout';
import { useToast } from '@/components/ui/use-toast';

interface DailySummary {
  date: string;
  day: number;
  sales: number;
  purchases: number;
  collections: number;
  payments: number;
  net_cash_flow: number;
  cumulative_cash_flow: number;
}

interface CompanySummary {
  company_name: string;
  company_category: string;
  total_amount: number;
  paid_amount: number;
  outstanding: number;
  transaction_count: number;
}

export default function FinancialSummaryPage() {
  const [selectedYear, setSelectedYear] = useState<string>(new Date().getFullYear().toString());
  const [selectedMonth, setSelectedMonth] = useState<string>((new Date().getMonth() + 1).toString());
  const [dailySummary, setDailySummary] = useState<DailySummary[]>([]);
  const [customers, setCustomers] = useState<CompanySummary[]>([]);
  const [suppliers, setSuppliers] = useState<CompanySummary[]>([]);
  const [monthlyTotal, setMonthlyTotal] = useState<any>(null);
  const [loading, setLoading] = useState(false);
  const { toast } = useToast();

  // ì›”ë³„ ì¬ë¬´ ì§‘ê³„ ì¡°íšŒ
  const fetchSummary = async () => {
    setLoading(true);
    try {
      const res = await fetch(`/api/financial/monthly-summary?year=${selectedYear}&month=${selectedMonth}`);
      const data = await res.json();

      if (data.success) {
        setDailySummary(data.data.daily_summary || []);
        setCustomers(data.data.customers || []);
        setSuppliers(data.data.suppliers || []);
        setMonthlyTotal(data.data.monthly_total);
      } else {
        toast({
          title: 'ì¡°íšŒ ì‹¤íŒ¨',
          description: data.error,
          variant: 'destructive'
        });
      }
    } catch (error) {
      console.error('Summary fetch error:', error);
      toast({
        title: 'ì¡°íšŒ ì‹¤íŒ¨',
        description: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
        variant: 'destructive'
      });
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchSummary();
  }, [selectedYear, selectedMonth]);

  // Excel Export
  const handleExcelExport = () => {
    window.open(
      `/api/export/financial-summary?year=${selectedYear}&month=${selectedMonth}`,
      '_blank'
    );
  };

  return (
    <MainLayout>
      <div className="container mx-auto p-6 space-y-6">
        {/* í—¤ë” */}
        <div className="flex justify-between items-center">
          <h1 className="text-3xl font-bold">ì›”ë³„ ì¬ë¬´ ì •ë¦¬ ë³´ë“œ</h1>

          <div className="flex gap-4 items-center">
            <select
              value={selectedYear}
              onChange={(e) => setSelectedYear(e.target.value)}
              className="px-4 py-2 border rounded-lg"
            >
              {[2023, 2024, 2025, 2026].map(year => (
                <option key={year} value={year}>{year}ë…„</option>
              ))}
            </select>

            <select
              value={selectedMonth}
              onChange={(e) => setSelectedMonth(e.target.value)}
              className="px-4 py-2 border rounded-lg"
            >
              {Array.from({ length: 12 }, (_, i) => i + 1).map(month => (
                <option key={month} value={month}>{month}ì›”</option>
              ))}
            </select>

            <button
              onClick={handleExcelExport}
              className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
            >
              Excel Export
            </button>
          </div>
        </div>

        {/* ì›”ë³„ ìš”ì•½ KPI */}
        {monthlyTotal && (
          <div className="grid grid-cols-2 md:grid-cols-6 gap-4">
            <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
              <div className="text-xs text-gray-600">ì´ ë§¤ì¶œ</div>
              <div className="text-xl font-bold text-blue-700 mt-1">
                {monthlyTotal.sales.toLocaleString('ko-KR')} ì›
              </div>
            </div>
            <div className="bg-red-50 p-4 rounded-lg border border-red-200">
              <div className="text-xs text-gray-600">ì´ ë§¤ì…</div>
              <div className="text-xl font-bold text-red-700 mt-1">
                {monthlyTotal.purchases.toLocaleString('ko-KR')} ì›
              </div>
            </div>
            <div className="bg-green-50 p-4 rounded-lg border border-green-200">
              <div className="text-xs text-gray-600">ì´ ìˆ˜ê¸ˆ</div>
              <div className="text-xl font-bold text-green-700 mt-1">
                {monthlyTotal.collections.toLocaleString('ko-KR')} ì›
              </div>
            </div>
            <div className="bg-orange-50 p-4 rounded-lg border border-orange-200">
              <div className="text-xs text-gray-600">ì´ ì§€ê¸‰</div>
              <div className="text-xl font-bold text-orange-700 mt-1">
                {monthlyTotal.payments.toLocaleString('ko-KR')} ì›
              </div>
            </div>
            <div className="bg-purple-50 p-4 rounded-lg border border-purple-200">
              <div className="text-xs text-gray-600">ìˆœ í˜„ê¸ˆíë¦„</div>
              <div className={`text-xl font-bold mt-1 ${monthlyTotal.net_cash_flow >= 0 ? 'text-green-700' : 'text-red-700'}`}>
                {monthlyTotal.net_cash_flow.toLocaleString('ko-KR')} ì›
              </div>
            </div>
            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
              <div className="text-xs text-gray-600">ì¬ê³  ê¸ˆì•¡</div>
              <div className="text-xl font-bold text-gray-700 mt-1">
                {monthlyTotal.stock_value.toLocaleString('ko-KR')} ì›
              </div>
            </div>
          </div>
        )}

        {/* ì¼ë³„ ì§‘ê³„ í…Œì´ë¸” */}
        <div className="bg-white rounded-lg shadow overflow-hidden">
          <div className="px-6 py-4 bg-gray-50 border-b">
            <h2 className="text-lg font-bold">ì¼ë³„ ì§‘ê³„ (1ì¼~30ì¼)</h2>
          </div>
          <div className="overflow-x-auto max-h-[400px] overflow-y-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50 sticky top-0">
                <tr>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500">ì¼ì</th>
                  <th className="px-4 py-3 text-right text-xs font-medium text-gray-500">ë§¤ì¶œ</th>
                  <th className="px-4 py-3 text-right text-xs font-medium text-gray-500">ë§¤ì…</th>
                  <th className="px-4 py-3 text-right text-xs font-medium text-gray-500">ìˆ˜ê¸ˆ</th>
                  <th className="px-4 py-3 text-right text-xs font-medium text-gray-500">ì§€ê¸‰</th>
                  <th className="px-4 py-3 text-right text-xs font-medium text-gray-500">ë‹¹ì¼ í˜„ê¸ˆíë¦„</th>
                  <th className="px-4 py-3 text-right text-xs font-medium text-gray-500">ëˆ„ì  í˜„ê¸ˆíë¦„</th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {dailySummary.map((day) => (
                  <tr key={day.day} className="hover:bg-gray-50">
                    <td className="px-4 py-2 whitespace-nowrap text-sm">{day.day}ì¼</td>
                    <td className="px-4 py-2 whitespace-nowrap text-sm text-right text-blue-600">
                      {day.sales.toLocaleString('ko-KR')}
                    </td>
                    <td className="px-4 py-2 whitespace-nowrap text-sm text-right text-red-600">
                      {day.purchases.toLocaleString('ko-KR')}
                    </td>
                    <td className="px-4 py-2 whitespace-nowrap text-sm text-right text-green-600">
                      {day.collections.toLocaleString('ko-KR')}
                    </td>
                    <td className="px-4 py-2 whitespace-nowrap text-sm text-right text-orange-600">
                      {day.payments.toLocaleString('ko-KR')}
                    </td>
                    <td className={`px-4 py-2 whitespace-nowrap text-sm text-right font-semibold ${day.net_cash_flow >= 0 ? 'text-green-700' : 'text-red-700'}`}>
                      {day.net_cash_flow.toLocaleString('ko-KR')}
                    </td>
                    <td className={`px-4 py-2 whitespace-nowrap text-sm text-right font-bold ${day.cumulative_cash_flow >= 0 ? 'text-green-700' : 'text-red-700'}`}>
                      {day.cumulative_cash_flow.toLocaleString('ko-KR')}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>

        {/* ê³ ê°ì‚¬/í˜‘ë ¥ì‚¬ ì§‘ê³„ */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          {/* ê³ ê°ì‚¬ ì§‘ê³„ */}
          <div className="bg-white rounded-lg shadow overflow-hidden">
            <div className="px-6 py-4 bg-blue-50 border-b">
              <h2 className="text-lg font-bold">ê³ ê°ì‚¬ë³„ ì§‘ê³„</h2>
            </div>
            <div className="overflow-y-auto max-h-[400px]">
              <table className="min-w-full">
                <thead className="bg-gray-50 sticky top-0">
                  <tr>
                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500">ê³ ê°ì‚¬ëª…</th>
                    <th className="px-4 py-2 text-right text-xs font-medium text-gray-500">ë§¤ì¶œ</th>
                    <th className="px-4 py-2 text-right text-xs font-medium text-gray-500">ìˆ˜ê¸ˆ</th>
                    <th className="px-4 py-2 text-right text-xs font-medium text-gray-500">ë¯¸ìˆ˜ê¸ˆ</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-200">
                  {customers.map((customer, index) => (
                    <tr key={index} className="hover:bg-gray-50">
                      <td className="px-4 py-2 text-sm">{customer.company_name}</td>
                      <td className="px-4 py-2 text-sm text-right">{customer.total_amount.toLocaleString('ko-KR')}</td>
                      <td className="px-4 py-2 text-sm text-right">{customer.paid_amount.toLocaleString('ko-KR')}</td>
                      <td className="px-4 py-2 text-sm text-right font-semibold text-red-600">
                        {customer.outstanding.toLocaleString('ko-KR')}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>

          {/* í˜‘ë ¥ì‚¬ ì§‘ê³„ */}
          <div className="bg-white rounded-lg shadow overflow-hidden">
            <div className="px-6 py-4 bg-orange-50 border-b">
              <h2 className="text-lg font-bold">í˜‘ë ¥ì‚¬ë³„ ì§‘ê³„</h2>
            </div>
            <div className="overflow-y-auto max-h-[400px]">
              <table className="min-w-full">
                <thead className="bg-gray-50 sticky top-0">
                  <tr>
                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500">í˜‘ë ¥ì‚¬ëª…</th>
                    <th className="px-4 py-2 text-right text-xs font-medium text-gray-500">ë§¤ì…</th>
                    <th className="px-4 py-2 text-right text-xs font-medium text-gray-500">ì§€ê¸‰</th>
                    <th className="px-4 py-2 text-right text-xs font-medium text-gray-500">ë¯¸ì§€ê¸‰ê¸ˆ</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-200">
                  {suppliers.map((supplier, index) => (
                    <tr key={index} className="hover:bg-gray-50">
                      <td className="px-4 py-2 text-sm">{supplier.company_name}</td>
                      <td className="px-4 py-2 text-sm text-right">{supplier.total_amount.toLocaleString('ko-KR')}</td>
                      <td className="px-4 py-2 text-sm text-right">{supplier.paid_amount.toLocaleString('ko-KR')}</td>
                      <td className="px-4 py-2 text-sm text-right font-semibold text-orange-600">
                        {supplier.outstanding.toLocaleString('ko-KR')}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </MainLayout>
  );
}
```

#### ê²€ì¦ ê¸°ì¤€
- [ ] í˜ì´ì§€ ë Œë”ë§ í™•ì¸
- [ ] ì›”ë³„ ìš”ì•½ KPI í™•ì¸
- [ ] ì¼ë³„ ì§‘ê³„ í…Œì´ë¸” í™•ì¸ (1ì¼~30ì¼)
- [ ] ê³ ê°ì‚¬/í˜‘ë ¥ì‚¬ ì§‘ê³„ í™•ì¸
- [ ] Excel Export ë™ì‘ í™•ì¸
- [ ] Excel ì •ë¦¬ ë³´ë“œì™€ ë°ì´í„° ë¹„êµ

---

## ğŸ”— Integration & Testing (1ì¼)

### E2E í…ŒìŠ¤íŠ¸ (qa persona)
**ë‹´ë‹¹ ì—ì´ì „íŠ¸**: `--persona-qa`
**ì†Œìš” ì‹œê°„**: 6-8ì‹œê°„

#### í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

1. **ì›”ë³„ ë‹¨ê°€ ê´€ë¦¬**
   - [ ] ë‹¨ê°€ ì´ë ¥ ì¡°íšŒ (10ì›”, 11ì›”, 12ì›”)
   - [ ] Excel í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
   - [ ] Excel Import (100ê°œ í’ˆëª©)
   - [ ] ë‹¨ê°€ ìˆ˜ì • (ê°œë³„ ìˆ˜ì •)

2. **ì¬ê³  ê¸ˆì•¡ ê³„ì‚°**
   - [ ] í’ˆëª©ë³„ ì¬ê³  ê¸ˆì•¡ ì¡°íšŒ
   - [ ] ì¹´í…Œê³ ë¦¬ë³„ ì§‘ê³„ ì¡°íšŒ
   - [ ] ì—…ì²´ë³„ ì§‘ê³„ ì¡°íšŒ
   - [ ] ì›”ë³„ ì¶”ì´ ì¡°íšŒ (6ê°œì›”)

3. **ì›”ë³„ ì¬ë¬´ ì •ë¦¬ ë³´ë“œ**
   - [ ] ì¼ë³„ ì§‘ê³„ ì¡°íšŒ (1ì¼~30ì¼)
   - [ ] ê³ ê°ì‚¬/í˜‘ë ¥ì‚¬ ì§‘ê³„ ì¡°íšŒ
   - [ ] Excel Export (6ê°œ ì‹œíŠ¸)
   - [ ] Excel ì •ë¦¬ ë³´ë“œì™€ ë°ì´í„° ë¹„êµ

4. **ì„±ëŠ¥ í…ŒìŠ¤íŠ¸**
   - [ ] 1000ê°œ í’ˆëª© ì¬ê³  ê¸ˆì•¡ ê³„ì‚° < 2ì´ˆ
   - [ ] ì›”ë³„ ì§‘ê³„ ì¡°íšŒ < 1ì´ˆ
   - [ ] Excel Export < 5ì´ˆ

---

## ğŸ“¦ ìµœì¢… Deliverables

### ë°ì´í„°ë² ì´ìŠ¤ (4ê°œ)
- [ ] `item_price_history` í…Œì´ë¸” (ì›”ë³„ ë‹¨ê°€ ì´ë ¥)
- [ ] `v_stock_valuation_monthly` ë·° (í’ˆëª©ë³„ ì¬ê³  ê¸ˆì•¡)
- [ ] `v_stock_value_by_category` ë·° (ì¹´í…Œê³ ë¦¬ë³„ ì¬ê³  ê¸ˆì•¡)
- [ ] `get_current_item_prices()` PostgreSQL í•¨ìˆ˜

### API ì—”ë“œí¬ì¸íŠ¸ (11ê°œ)
- [ ] GET /api/price-history/[itemId] - í’ˆëª©ë³„ ë‹¨ê°€ ì´ë ¥
- [ ] GET /api/price-history/current - í˜„ì¬ ì›” ë‹¨ê°€
- [ ] POST /api/price-history - ë‹¨ê°€ ë“±ë¡ (ëŒ€ëŸ‰)
- [ ] PUT /api/price-history/[id] - ë‹¨ê°€ ìˆ˜ì •
- [ ] GET /api/stock/valuation - í’ˆëª©ë³„ ì¬ê³  ê¸ˆì•¡
- [ ] GET /api/stock/valuation/category - ì¹´í…Œê³ ë¦¬ë³„ ì¬ê³  ê¸ˆì•¡
- [ ] GET /api/stock/valuation/supplier - ì—…ì²´ë³„ ì¬ê³  ê¸ˆì•¡
- [ ] GET /api/financial/monthly-summary - ì›”ë³„ ì¬ë¬´ ì§‘ê³„
- [ ] GET /api/download/template/price-history - Excel í…œí”Œë¦¿
- [ ] POST /api/upload/price-history - Excel Import
- [ ] GET /api/export/financial-summary - Excel Export

### í”„ë¡ íŠ¸ì—”ë“œ í˜ì´ì§€ (3ê°œ)
- [ ] /price-management - ì›”ë³„ ë‹¨ê°€ ê´€ë¦¬
- [ ] /stock/valuation - ì¬ê³  ê¸ˆì•¡ ëŒ€ì‹œë³´ë“œ
- [ ] /financial/summary - ì›”ë³„ ì¬ë¬´ ì •ë¦¬ ë³´ë“œ

### ë¼ì´ë¸ŒëŸ¬ë¦¬ (2ê°œ)
- [ ] src/lib/stock-value-calculator.ts - ì¬ê³  ê¸ˆì•¡ ê³„ì‚° ì—”ì§„
- [ ] src/lib/monthly-financial-aggregator.ts - ì›”ë³„ ì¬ë¬´ ì§‘ê³„ ë¡œì§

### í…ŒìŠ¤íŠ¸ (1ê°œ)
- [ ] E2E í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ (4ê°œ ì¹´í…Œê³ ë¦¬, 14ê°œ í…ŒìŠ¤íŠ¸)

---

## ğŸ¯ ì„±ê³µ ê¸°ì¤€

1. **ê¸°ëŠ¥ ì™„ì„±ë„**: ëª¨ë“  Deliverables 100% êµ¬í˜„
2. **ë°ì´í„° ì •í™•ë„**: Excel ì •ë¦¬ ë³´ë“œì™€ 100% ì¼ì¹˜
3. **ì„±ëŠ¥ ëª©í‘œ**: ëª¨ë“  API < 2ì´ˆ, Excel Export < 5ì´ˆ
4. **ì‚¬ìš©ì„±**: Excel ëŒ€ì²´ ê°€ëŠ¥í•œ UX
5. **í’ˆì§ˆ**: 0 Critical Bug, 0 Korean Encoding Issue

---

## ğŸ“… Timeline Summary

| Wave | ê¸°ê°„ | íƒœìŠ¤í¬ ìˆ˜ | ì£¼ìš” Deliverables |
|------|------|----------|------------------|
| Wave 1 | 3-4ì¼ | 5ê°œ | DB ìŠ¤í‚¤ë§ˆ, ë‹¨ê°€ API (7ê°œ), Excel Import/Export |
| Wave 2 | 4-5ì¼ | 3ê°œ | ì¬ê³  ê¸ˆì•¡ ê³„ì‚° ì—”ì§„, ì›”ë³„ ì§‘ê³„ ë¡œì§, Excel Export |
| Wave 3 | 4-5ì¼ | 3ê°œ | ë‹¨ê°€ ê´€ë¦¬ í˜ì´ì§€, ì¬ê³  ê¸ˆì•¡ ëŒ€ì‹œë³´ë“œ, ì •ë¦¬ ë³´ë“œ |
| Integration | 1ì¼ | 1ê°œ | E2E í…ŒìŠ¤íŠ¸, ë°ì´í„° ê²€ì¦ |
| **Total** | **12-15ì¼** | **12ê°œ** | **11 APIs + 3 Pages + 4 DB Objects + 2 Libraries** |

---

**ì‘ì„±ì¼**: 2025-10-16
**ì‘ì„±ì**: SuperClaude (Phase P3 Planning)
**ê¸°ë°˜ ë¬¸ì„œ**: ëŒ€í™” ìš”ì•½ë³¸ (2025.10.13 íšŒì˜ë¡)
